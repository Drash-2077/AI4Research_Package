<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI4Research Cloud</title>
    <link rel="icon" type="image/x-icon" href="/static/me.ico">
    
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Ant Design -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/5.12.2/antd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/5.12.2/reset.min.css">
    
    <!-- Icons -->
    <script src="https://cdn.jsdelivr.net/npm/@ant-design/icons@5.2.6/dist/index.umd.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.27.0/plotly.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-resizable/3.0.5/react-resizable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="/static/auth.js?v=20240127"></script>

    <style>
        /* Loading Spinner */
        #app-loading {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f5f6fa;
            z-index: 9999;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ddd;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Global Variables --- */
        :root {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --bg-global: #f5f6fa;
            --bg-sidebar: #2c3e50;
            --text-main: #2c3e50;
            --text-light: #ecf0f1;
            --border-color: #dcdcdc;
            --danger-color: #e74c3c;
            --btn-orange: #e67e22;
            --btn-purple: #8e44ad;
            --btn-cyan: #16a085;
        }

        body { 
            margin: 0; padding: 0; 
            font-family: "Microsoft YaHei", "SimHei", -apple-system, sans-serif;
            background-color: var(--bg-global);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }
        #root { height: 100%; display: flex; flex-direction: column; }
        
        /* --- Layout Structure --- */
        .app-header {
            height: 60px;
            background: white;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
        }
        
        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* 1. Left Sidebar (History) */
        .col-history {
            width: 240px;
            background-color: var(--bg-sidebar);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .history-header {
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .history-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            color: #bdc3c7;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .history-item:hover { background-color: rgba(255,255,255,0.1); color: white; }
        .history-item.active { background-color: #34495e; color: white; border-left: 3px solid var(--primary-color); }
        .history-footer {
            padding: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* 2. Center Panel (Control) */
        .col-control {
            width: 380px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .control-tabs .ant-tabs-nav { margin-bottom: 0; padding: 0 10px; }
        .control-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* 3. Right Panel (Workspace) */
        .col-workspace {
            flex: 1;
            background-color: var(--bg-global);
            padding: 20px;
            overflow: hidden; /* Prevent double scroll */
            display: flex;
            flex-direction: column;
        }

        /* --- Components Overrides --- */
        .custom-btn { border: none; color: white; font-weight: bold; border-radius: 4px; display: flex; justify-content: center; align-items: center; }
        .btn-orange { background-color: var(--btn-orange); }
        .btn-purple { background-color: var(--btn-purple); }
        .btn-cyan { background-color: var(--btn-cyan); }
        .btn-danger { background-color: var(--danger-color); }
        
        .section-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .card-header { padding: 12px 16px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 15px; flex-shrink: 0; }
        .card-body { padding: 16px; flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        /* Upload full width fix - Force Override */
        .ant-upload-wrapper { width: 100% !important; display: block !important; }
        .ant-upload { width: 100% !important; display: block !important; }
        .ant-upload-select { width: 100% !important; display: block !important; }
        .ant-upload-select .ant-btn { width: 100% !important; }

        /* React Resizable */
        .react-resizable {
            position: relative;
            background-clip: padding-box;
        }
        .react-resizable-handle {
            position: absolute;
            right: -5px;
            bottom: 0;
            z-index: 1;
            width: 10px;
            height: 100%;
            cursor: col-resize;
        }
        
        /* Modal Styles */
    </style>
</head>
<body>
    <div id="app-loading">
        <div class="spinner"></div>
        <div style="margin-top: 20px; color: #666; font-family: sans-serif;">Loading AI4Research...</div>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Layout, Menu, Upload, Button, message, Table, Card, Select, Form, Input, Row, Col, Typography, Space, Tag, Empty, Spin, Result } = antd;

        // --- Icon Handling with Fallback ---
        let icons = window.icons || {};
        const IconFallback = () => <span style={{marginRight:8}}>?</span>;
        
        // Proxy to handle missing icons gracefully
        const iconHandler = {
            get: function(target, prop) {
                return target[prop] || IconFallback;
            }
        };
        icons = new Proxy(icons, iconHandler);

        const { UploadOutlined, BarChartOutlined, FileTextOutlined, CloudUploadOutlined, ExperimentOutlined, RobotOutlined, PlayCircleOutlined, SaveOutlined, DeleteOutlined, SettingOutlined, GlobalOutlined, KeyOutlined, FileAddOutlined, PlusOutlined, DownloadOutlined, LinkOutlined, InfoCircleOutlined, GroupOutlined, CheckCircleOutlined, MailOutlined } = icons;
        
        // --- Error Boundary ---
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                this.setState({ error, errorInfo });
                console.error("Uncaught error:", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: 50, textAlign: 'center' }}>
                            <Result
                                status="500"
                                title="Something went wrong"
                                subTitle="Sorry, the application crashed."
                                extra={
                                    <div style={{ textAlign: 'left', background: '#f5f5f5', padding: 20, borderRadius: 4, overflow: 'auto', maxHeight: 300 }}>
                                        <p style={{ color: 'red', fontWeight: 'bold' }}>{this.state.error && this.state.error.toString()}</p>
                                        <pre style={{ fontSize: 12 }}>{this.state.errorInfo && this.state.errorInfo.componentStack}</pre>
                                    </div>
                                }
                            />
                            <Button type="primary" onClick={() => window.location.reload()}>Reload Page</Button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const { Header, Sider, Content } = Layout;
        const { Title, Text } = Typography;
        const { Option } = Select;
        const { Checkbox, Radio, Tabs, InputNumber, Modal, Tooltip, Badge } = antd;
        // DeleteOutlined is already in the destructured list from 'icons' above
        // We only need to add PlusOutlined if it's missing, but let's check the list above first.
        // The list above is: UploadOutlined, BarChartOutlined, FileTextOutlined, CloudUploadOutlined, ExperimentOutlined, RobotOutlined, PlayCircleOutlined, SaveOutlined, DeleteOutlined, SettingOutlined, GlobalOutlined, KeyOutlined, FileAddOutlined
        // PlusOutlined is MISSING from the first list.
        // DeleteOutlined is PRESENT in the first list.
        // So we should only destructure PlusOutlined here, or better yet, add it to the top list.
        
        // Let's add PlusOutlined to the main list and remove this line to avoid duplicate declaration error.
        
        // --- Resizable Header Component ---
        const ResizableTitle = (props) => {
            const { onResize, width, ...restProps } = props;

            if (!width) {
                return <th {...restProps} />;
            }

            // Access Resizable from global window.ReactResizable
            // Note: cdnjs react-resizable exports window.ReactResizable.Resizable
            const Resizable = window.ReactResizable?.Resizable;
            
            if (!Resizable) return <th {...restProps} />;

            return (
                <Resizable
                    width={width}
                    height={0}
                    handle={
                        <span
                            className="react-resizable-handle"
                            onClick={(e) => {
                                e.stopPropagation();
                            }}
                        />
                    }
                    onResize={onResize}
                    draggableOpts={{ enableUserSelectHack: false }}
                >
                    <th {...restProps} />
                </Resizable>
            );
        };

        // Remove loading spinner once React mounts
        setTimeout(() => {
            const loader = document.getElementById('app-loading');
            if (loader) loader.style.opacity = '0';
            setTimeout(() => { if(loader) loader.remove(); }, 500);
        }, 500);

        // --- Translations ---

        // --- Editable Title Component ---
        const EditableTitle = ({ value, onSave, ...props }) => {
            const [editing, setEditing] = useState(false);
            const [tempVal, setTempVal] = useState(value);

            // Sync tempVal if value prop changes externally (though unlikely while editing)
            useEffect(() => {
                if (!editing) setTempVal(value);
            }, [value, editing]);

            const handleDouble = (e) => {
                e.stopPropagation(); // Prevent sort/drag trigger
                setEditing(true);
                setTempVal(value);
            };

            const handleBlur = () => {
                setEditing(false);
                if (tempVal !== value) {
                    onSave(tempVal);
                }
            };
            
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    handleBlur();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    e.stopPropagation();
                    setEditing(false);
                    setTempVal(value);
                }
            };

            if (editing) {
                return (
                    <Input 
                        value={tempVal} 
                        onChange={e => setTempVal(e.target.value)} 
                        onBlur={handleBlur} 
                        onKeyDown={handleKeyDown}
                        autoFocus
                        size="small"
                        onClick={e => e.stopPropagation()}
                        style={{ width: '100%' }}
                    />
                );
            }

            return (
                <div 
                    onDoubleClick={handleDouble} 
                    style={{ cursor: 'text', width: '100%', display: 'flex', alignItems: 'center' }}
                    title="Double click to rename"
                >
                    {value}
                </div>
            );
        };

        const TRANSLATIONS = {
            en: {
                // Sidebar
                title: "History (Data List)",
                import: "Import Data",
                export: "Export Data",
                clear: "Delete Selected",
                lang: "中文",
                license: "License Manager",
                quota: "Quota",
                login: "Login",
                logout: "Logout",
                crawl_quota: "Crawl Quota",
                analysis_quota: "Analysis Quota",
                vis_quota: "Visualization Quota",
                interpret_quota: "Interpretation Quota",
                success: "Success",
                cleared: "Selected files deleted!",
                aggregate: "Aggregate",
                aggregate_title: "Aggregate Files",
                dedup_col: "Deduplicate Column (Optional)",
                output_name: "Output Filename",
                aggregating: "Aggregating...",
                aggregated: "Files Aggregated Successfully!",
                
                // Tabs
                tab_acq: "Acquisition",
                tab_label: "Labeling",
                tab_prep: "Preprocess",
                tab_anal: "Analysis",
                tab_plot: "Visualization",

                // Acquisition
                acq_title: "Data Acquisition",
                platform: "Platform",
                cookie_status: "Cookie Status",
                configured: "Configured",
                missing: "Missing",
                upload: "Upload",
                keywords: "Keywords",
                max_count: "Max Count",
                start_crawl: "Start Crawling",
                ready_crawl: "Ready to crawl...",
                cookie_upload_success: "Cookie uploaded successfully",
                cookie_upload_fail: "Upload failed",
                cookie_check_fail: "Please upload a cookie file first!",

                // Preprocess
                prep_title: "Data Preprocessing",
                target_file: "Target:",
                none_selected: "None selected",
                operation: "Operation",
                target_col: "Target Column",
                separator: "Separator",
                method: "Method",
                run_exec: "Execute",
                run_save: "Save & Load",
                op_split: "Split & One-Hot",
                op_explode: "Explode Rows",
                op_count: "Count Values",
                op_log: "Log Transform",
                op_merge_pca: "Merge (PCA)",
                op_merge_avg: "Merge (Average)",
                op_aggregate: "Aggregate Columns",
                op_impute: "Impute Missing",
                meth_mean: "Mean",
                meth_median: "Median",
                meth_constant: "Constant (0)",
                target_cols: "Target Columns (comma-sep)",
                deduplicate: "Deduplicate",
                new_col_name: "New Column Name",

                // Analysis
                anal_title: "Statistical Analysis",
                anal_type: "Analysis Type",
                group_col: "Group Column",
                val_cols: "Value Columns",
                run_anal: "Run Analysis",
                type_ttest: "Independent T-test",
                type_anova: "One-way ANOVA",

                // Visualization
                plot_title: "Visualization",
                plot_type: "Plot Type",
                x_axis: "X Axis",
                y_axis: "Y Axis",
                color_by: "Color By",
                gen_plot: "Generate Plot",
                pt_scatter: "Scatter Plot",
                pt_bar: "Bar Chart",
                pt_box: "Box Plot",
                pt_hist: "Histogram",
                pt_violin: "Violin Plot",
                pt_heatmap: "Correlation Heatmap",
                pt_line: "Line Plot",
                pt_donut: "Donut Chart",
                pt_density: "Density Heatmap",
                pt_stacked_bar: "Stacked Bar Chart",
                pt_forest_linear: "Forest Plot (Linear)",
                pt_forest_logistic: "Forest Plot (Binary Logistic)",
                pt_forest_multinomial: "Forest Plot (Multinomial)",
                pt_forest_ordinal: "Forest Plot (Ordinal)",
                pt_sig_matrix: "Significance Matrix",
                
                font_size: "Font Size",
                font_family: "Font Family",
                font_times: "Times New Roman",
                font_arial: "Arial",
                font_bold: "Bold Text",
                width: "Width (px)",
                height: "Height (px)",
                export_tiff: "Export TIFF",
                trendline: "Trendline (Linear Regression)",
                heatmap_cols: "Columns to Analyze",
                hue_group: "Group / Color",
                palette: "Palette",
                add_sig: "Add Significance Stars",
                sig_method: "Test Method",
                sig_correction: "Correction",
                sort_effect: "Sort by Effect Size",
                sig_group: "Group Variable",
                sig_val: "Value Variable",
                sig_corr_method: "Correlation Method",
                central_tendency: "Central Tendency",
                tendency_tooltip: "Choose between Mean (Parametric) or Median (Non-parametric) for plotting and statistical analysis.",
                tendency_mean: "Mean ± SD (Parametric)",
                tendency_median: "Median (IQR) (Non-parametric)",

                // Labeling
                lbl_title: "Labeling Task",
                drag_text: "Click or drag file to this area to upload",
                create_task: "Create New Task",
                lbl_annotator_name: "Annotator Name",
                lbl_enter_name_placeholder: "Enter your name",
                lbl_field_config: "Field Configuration",
                lbl_add_field: "Add Field",
                lbl_no_fields: "No fields added. Click \"Add Field\" to start.",
                lbl_start_labeling: "Start Labeling",
                lbl_select_preset: "Select Preset",
                lbl_create_custom: "Create Custom",
                lbl_choose_preset: "Choose a preset field:",
                lbl_name: "Name",
                lbl_type: "Type",
                lbl_options: "Options (comma separated)",
                lbl_preset: "Preset",
                lbl_custom: "Custom",
                lbl_type_text: "Manual Entry",
                lbl_type_single: "Single Choice",
                lbl_type_multi: "Multiple Choice",
                lbl_label_cn: "Label (CN)",
                lbl_label_en: "Label (EN)",
                lbl_action: "Action",
                lbl_cancel: "Cancel",
                lbl_confirm: "Confirm",
                lbl_edit: "Edit",
                lbl_delete: "Delete",
                lbl_save: "Save",
                
                // Field Presets
                lbl_is_excluded: "Is Excluded?",
                lbl_mdiscern: "mDiscern Score",
                lbl_jama: "JAMA Score",
                lbl_gqs: "GQS Score",
                lbl_remarks: "Remarks",
                
                // Workspace
                ws_title: "Workspace",
                ws_acq_desc: "Crawler logs shown in Control Panel. Results will appear in History.",
                ws_anal_desc: "Run an analysis to see results here",
                ws_prep_desc: "Preprocessing creates a new file based on the selected one.",
                ws_plot_desc: "Generate a plot to see it here",
                ws_lbl_desc: "Select a file from History to play",
                vid_player: "Video Player Area",
                dl_video: "Download Video",
                open_link: "Open Source Link",
                lbl_settings_title: "Set Data Directory",
                lbl_data_dir: "Set Data Dir",
                lbl_video_path: "Data Root Directory",
                lbl_video_path_help: "Root directory for AI4Research data. A 'AI4ResearchDatabase' folder will be created here.",
                lbl_select_folder: "Select Folder",
                lbl_folder_required: "Please select a data directory to continue.",
                quota_exhausted: "Quota Exhausted",
                quota_crawl_exhausted_msg: "You have run out of crawl quota.",
                quota_analyze_exhausted_msg: "You have run out of analysis quota.",
                quota_vis_exhausted_msg: "You have run out of visualization quota.",
                quota_interpret_exhausted_msg: "You have run out of interpretation quota.",
                contact_us: "Contact Us",
                contact_info: "Contact Information"
            },
            cn: {
                // Sidebar
                title: "数据列表",
                import: "导入数据",
                export: "导出数据",
                clear: "删除选中",
                lang: "English", // Fixed: Show target language
                license: "授权管理",
                quota: "配额",
                login: "登录",
                logout: "注销",
                crawl_quota: "爬虫配额",
                analysis_quota: "分析配额",
                vis_quota: "绘图配额",
                interpret_quota: "解读配额",
                success: "成功",
                cleared: "已删除选中文件！",
                aggregate: "合并选中",
                aggregate_title: "合并文件",
                dedup_col: "去重字段 (可选)",
                output_name: "输出文件名",
                aggregating: "正在合并...",
                aggregated: "文件合并成功！",

                // Tabs
                tab_acq: "数据获取",
                tab_label: "数据标注",
                tab_prep: "数据预处理",
                tab_anal: "统计分析",
                tab_plot: "可视化绘图",

                // Acquisition
                acq_title: "数据获取",
                platform: "平台",
                cookie_status: "Cookie 状态",
                configured: "已配置",
                missing: "缺失",
                upload: "上传",
                keywords: "关键词",
                max_count: "抓取数量",
                start_crawl: "开始抓取",
                ready_crawl: "准备就绪...",
                cookie_upload_success: "Cookie 上传成功",
                cookie_upload_fail: "上传失败",
                cookie_check_fail: "请先上传 Cookie 文件！",

                // Preprocess
                prep_title: "数据预处理",
                target_file: "当前目标:",
                none_selected: "未选择",
                operation: "操作类型",
                target_col: "目标列",
                separator: "分隔符",
                method: "填充方法",
                run_exec: "执行",
                run_save: "保存并加载",
                op_split: "拆分与独热编码",
                op_explode: "展开行 (Explode)",
                op_count: "计数统计",
                op_log: "对数变换",
                op_merge_pca: "合并变量 (PCA)",
                op_merge_avg: "合并变量 (平均值)",
                op_aggregate: "列聚合",
                op_impute: "缺失值填充",
                meth_mean: "均值",
                meth_median: "中位数",
                meth_constant: "常数 (0)",
                target_cols: "目标列 (逗号分隔)",
                deduplicate: "去重",
                new_col_name: "新列名",
                meth_constant: "常数0",

                // Analysis
                anal_title: "统计分析",
                anal_type: "分析类型",
                group_col: "分组列",
                val_cols: "数值列",
                run_anal: "运行分析",
                type_ttest: "独立样本 T 检验",
                type_anova: "单因素方差分析 (ANOVA)",

                // Visualization
                plot_title: "可视化",
                plot_type: "图表类型",
                x_axis: "X 轴",
                y_axis: "Y 轴",
                color_by: "颜色分组",
                gen_plot: "生成图表",
                pt_scatter: "散点图",
                pt_bar: "柱状图",
                pt_box: "箱线图",
                pt_hist: "直方图",
                pt_violin: "小提琴图",
                pt_heatmap: "相关性热力图",
                pt_line: "折线图",
                pt_donut: "圆环图",
                pt_stacked_bar: "堆叠柱状图",
                pt_forest_linear: "森林图 (线性回归)",
                pt_forest_logistic: "森林图 (二元逻辑回归)",
                pt_forest_multinomial: "森林图 (无序逻辑回归)",
                pt_forest_ordinal: "森林图 (有序回归)",
                pt_sig_matrix: "显著性矩阵",
                
                font_size: "字体大小",
                font_family: "字体",
                font_times: "Times New Roman",
                font_arial: "Arial",
                font_bold: "字体加粗",
                width: "图像宽度 (px)",
                height: "图像高度 (px)",
                export_tiff: "导出 TIFF",
                trendline: "显示趋势线 (线性回归)",
                heatmap_cols: "分析列 (默认所有数值列)",
                hue_group: "分组 / 颜色",
                palette: "配色方案",
                add_sig: "添加显著性标记",
                sig_method: "检验方法",
                sig_correction: "P值校正",
                sort_effect: "按效应值排序",
                sig_group: "分组变量",
                sig_val: "数值变量",
                sig_corr_method: "相关性方法",
                lbl_group_var: "分组变量",
                lbl_analysis_var: "分析变量",
                central_tendency: "集中趋势",
                tendency_tooltip: "选择均值（参数检验）或中位数（非参数检验）用于绘图和统计分析。",
                tendency_mean: "均值 ± 标准差 (参数检验)",
                tendency_median: "中位数 (四分位距) (非参数检验)",

                // Labeling
                lbl_title: "标注任务",
                drag_text: "点击或拖拽文件到此处上传",
                create_task: "创建新任务",
                lbl_annotator_name: "标注员姓名",
                lbl_enter_name_placeholder: "输入您的姓名",
                lbl_selected_fields: "已选字段",
                lbl_field_config: "字段配置",
                lbl_add_field: "添加字段",
                lbl_no_fields: "暂无字段，点击“添加字段”开始配置。",
                lbl_start_labeling: "开始标注",
                lbl_select_preset: "选择预设",
                lbl_create_custom: "创建自定义",
                lbl_choose_preset: "选择预设字段：",
                lbl_name: "字段键名 (例如 age)",
                lbl_label_cn: "显示名称 (中文)",
                lbl_label_en: "显示名称 (英文)",
                lbl_type: "类型",
                lbl_options: "选项 (逗号分隔)",
                lbl_preset: "预设",
                lbl_custom: "自定义",
                lbl_type_text: "手动键入",
                lbl_type_single: "单选",
                lbl_type_multi: "多选",
                lbl_label_cn: "显示名称 (中文)",
                lbl_label_en: "显示名称 (英文)",
                lbl_action: "操作",
                lbl_cancel: "取消",
                lbl_confirm: "确认",
                lbl_edit: "编辑",
                lbl_delete: "删除",
                lbl_save: "保存",

                // Field Presets
                lbl_is_excluded: "是否剔除",
                lbl_mdiscern: "mDiscern 评分",
                lbl_jama: "JAMA 评分",
                lbl_gqs: "GQS 质量评分",
                lbl_remarks: "备注",

                // Workspace
                ws_title: "工作区",
                ws_acq_desc: "爬虫日志显示在左侧控制面板。结果将出现在历史记录中。",
                ws_anal_desc: "运行分析以在此处查看结果",
                ws_prep_desc: "在原始文件基础上生成新的预处理结果文件。",
                ws_plot_desc: "生成图表以在此处查看",
                ws_lbl_desc: "从历史记录选择文件以播放",
                vid_player: "视频播放区",
                dl_video: "下载视频",
                open_link: "打开原链接",
                lbl_settings_title: "设置数据目录",
                lbl_data_dir: "设置数据目录",
                lbl_video_path: "数据根目录",
                lbl_video_path_help: "AI4Research 数据的根目录。系统将在此处创建 'AI4ResearchDatabase' 文件夹。",
                lbl_select_folder: "选择目录",
                lbl_folder_required: "请选择数据目录以继续。",
                quota_exhausted: "配额已用尽",
                quota_crawl_exhausted_msg: "您的爬虫配额已用尽。",
                quota_analyze_exhausted_msg: "您的分析配额已用尽。",
                quota_vis_exhausted_msg: "您的绘图配额已用尽。",
                quota_interpret_exhausted_msg: "您的AI解读配额已用尽。",
                contact_us: "联系我们",
                contact_info: "联系方式"
            }
        };

        // --- Modal Components ---
        const LoginModal = ({ visible, onClose, t }) => {
            const [loading, setLoading] = useState(false);
            const [isRegister, setIsRegister] = useState(false);
            const [form] = Form.useForm();

            // Reset state on open
            useEffect(() => {
                if (visible) {
                    setIsRegister(false);
                    form.resetFields();
                }
            }, [visible]);

            const handleAuth = async (values) => {
                if (!values.username?.trim() || !values.password?.trim()) {
                    return message.warning("Username and Password cannot be empty");
                }
                
                setLoading(true);
                try {
                    if (isRegister) {
                        await window.Auth.register(values.username, values.password, values.email);
                        message.success("Registration successful!");
                        onClose();
                    } else {
                        await window.Auth.login(values.username, values.password);
                        message.success("Login successful");
                        onClose();
                    }
                } catch (e) {
                    message.error(e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <Modal title={isRegister ? "Register" : "Login"} open={visible} onCancel={onClose} footer={null} width={400}>
                    <Tabs 
                        activeKey={isRegister ? 'register' : 'login'} 
                        onChange={(k) => setIsRegister(k === 'register')}
                        centered
                        items={[
                            { key: 'login', label: 'Login' },
                            { key: 'register', label: 'Register' }
                        ]}
                    />
                    <Form form={form} layout="vertical" onFinish={handleAuth} style={{marginTop: 20}}>
                        <Form.Item name="username" label="Username" rules={[{ required: true, message: 'Required' }]}>
                            <Input placeholder="Username" />
                        </Form.Item>
                        <Form.Item name="password" label="Password" rules={[{ required: true, message: 'Required' }]}>
                            <Input.Password placeholder="Password" />
                        </Form.Item>
                        {isRegister && (
                            <Form.Item name="email" label="Email">
                                <Input placeholder="Email (Optional)" />
                            </Form.Item>
                        )}
                        <Button type="primary" htmlType="submit" loading={loading} block style={{ background: '#3498db' }}>
                            {isRegister ? "Register" : t.login}
                        </Button>
                    </Form>
                </Modal>
            );
        };

        // --- History Widget Component (Left Sidebar) ---
        const HistoryWidget = ({ onFileSelect, lang, setLang }) => {
            const [files, setFiles] = useState([]);
            const [selectedId, setSelectedId] = useState(null);
            const [checkedFiles, setCheckedFiles] = useState(new Set());
            const [showAggregate, setShowAggregate] = useState(false);
            const [aggregateDedupCol, setAggregateDedupCol] = useState(undefined);
            const [aggregateOutputName, setAggregateOutputName] = useState("Aggregation");
            const [aggregateColumns, setAggregateColumns] = useState([]);
            
            const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];
            
            // Fetch Real Data
            useEffect(() => {
                fetchFiles();
                // Poll for new files every 5s (simple live update)
                const interval = setInterval(fetchFiles, 5000);
                return () => clearInterval(interval);
            }, []);

            const fetchFiles = () => {
                fetch('/api/data/list')
                    .then(r => r.json())
                    .then(data => {
                        // Filter out temporary files and config files
                        data = data.filter(f => 
                            !f.name.startsWith('~$') && 
                            !f.name.startsWith('.') &&
                            !f.name.endsWith('.config.json')
                        );

                        // Separate originals and tasks
                        const originals = [];
                        const tasks = [];
                        
                        data.forEach(f => {
                            // Check if it is a task based on filename pattern (contains "标注员_")
                            // or path (starts with labeled_data/)
                            const baseName = f.name.split('/').pop().split('\\').pop();
                            if (baseName.startsWith("标注员_")) {
                                tasks.push(f);
                            } else {
                                originals.push(f);
                            }
                        });
                        
                        // Map tasks to parents
                        const taskMap = new Map(); // parentName -> [tasks]
                        const orphans = [];

                        tasks.forEach(t => {
                            const tBase = t.name.split('/').pop().split('\\').pop();
                            // Task name format: 标注员_{annotator}_{originalBase}.xlsx
                            // We need to extract {originalBase}.
                            // Regex: ^标注员_.*?_(.*)\.xlsx$
                            const match = tBase.match(/^标注员_.*?_(.*)\.xlsx$/);
                            let parent = null;
                            
                            if (match) {
                                const originalBase = match[1];
                                // Find parent whose basename matches originalBase
                                parent = originals.find(o => {
                                    const oBase = o.name.split('/').pop().split('\\').pop();
                                    const oBaseNoExt = oBase.substring(0, oBase.lastIndexOf('.')) || oBase;
                                    return oBaseNoExt === originalBase;
                                });
                            }

                            if (parent) {
                                if (!taskMap.has(parent.name)) {
                                    taskMap.set(parent.name, []);
                                }
                                taskMap.get(parent.name).push(t);
                            } else {
                                orphans.push(t);
                            }
                        });
                        
                        // Build processed list
                        const processed = [];
                        let idCounter = 0;
                        const addedNames = new Set();
                        
                        originals.forEach(orig => {
                            if (addedNames.has(orig.name)) return;
                            
                            const origBase = orig.name.split('/').pop().split('\\').pop();
                            processed.push({
                                id: idCounter++,
                                name: orig.name,
                                displayName: origBase,
                                active: false,
                                fileObj: orig,
                                indent: 0
                            });
                            addedNames.add(orig.name);
                            
                            if (taskMap.has(orig.name)) {
                                taskMap.get(orig.name).forEach(task => {
                                    if (addedNames.has(task.name)) return;
                                    
                                    const taskBase = task.name.split('/').pop().split('\\').pop();
                                    processed.push({
                                        id: idCounter++,
                                        name: task.name,
                                        displayName: taskBase,
                                        active: false,
                                        fileObj: task,
                                        indent: 1
                                    });
                                    addedNames.add(task.name);
                                });
                            }
                        });
                        
                        // Add orphans at root level
                        orphans.forEach(t => {
                            if (addedNames.has(t.name)) return;
                            
                            const tBase = t.name.split('/').pop().split('\\').pop();
                            processed.push({
                                id: idCounter++,
                                name: t.name,
                                displayName: tBase,
                                active: false,
                                fileObj: t,
                                indent: 0
                            });
                            addedNames.add(t.name);
                        });
                        
                        setFiles(processed);
                    })
                    .catch(err => console.error("Failed to load history"));
            };

            const handleFileClick = (file) => {
                setSelectedId(file.id);
                if (onFileSelect) {
                    onFileSelect(file);
                }
            };
            
            const handleCheckboxChange = (e, fileName) => {
                e.stopPropagation(); // Prevent triggering row click
                const newChecked = new Set(checkedFiles);
                if (e.target.checked) {
                    newChecked.add(fileName);
                } else {
                    newChecked.delete(fileName);
                }
                setCheckedFiles(newChecked);
            };

            const handleDeleteSelected = () => {
                if (checkedFiles.size === 0) {
                    return message.warning("Please select files to delete");
                }
                
                Modal.confirm({
                    title: t.clear,
                    content: `Delete ${checkedFiles.size} selected file(s)?`,
                    onOk: () => {
                        fetch('/api/data/batch_delete', { 
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ filenames: Array.from(checkedFiles) })
                        })
                            .then(r => r.json())
                            .then(res => {
                                message.success(t.cleared);
                                setCheckedFiles(new Set()); // Clear selection
                                fetchFiles(); 
                            });
                    }
                });
            };

            const handleExportSelected = () => {
                if (checkedFiles.size === 0) {
                    return message.warning("Please select files to export");
                }
                
                const fileList = Array.from(checkedFiles);
                if (fileList.length === 1) {
                    // Single file
                    window.open(`/api/data/download?filename=${encodeURIComponent(fileList[0])}`, '_blank');
                } else {
                    // Batch
                    message.loading("Preparing zip...", 1);
                    fetch('/api/data/download_batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ filenames: fileList })
                    })
                    .then(response => {
                        if (response.ok) return response.blob();
                        throw new Error("Export failed");
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        // Attempt to extract filename from header or default
                        a.download = `export_${new Date().toISOString().slice(0,19).replace(/[-:T]/g,'')}.zip`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(url);
                        message.success("Export started");
                    })
                    .catch(err => message.error(err.message));
                }
            };

            return (
                <div className="col-history">
                    <div className="history-header">{t.title}</div>
                    
                    <div style={{ padding: '15px' }}>
                        <Upload 
                            showUploadList={false} 
                            className="full-width-upload"
                            beforeUpload={async (file) => {
                                const fd = new FormData();
                                fd.append('file', file);
                                try {
                                    await fetch('/api/data/upload', { method: 'POST', body: fd });
                                    message.success(t.success);
                                    fetchFiles();
                                } catch(e) { message.error('Upload failed'); }
                                return false;
                            }}
                        >
                            <Button type="primary" className="custom-btn" block icon={<CloudUploadOutlined />} style={{ background: '#3498db', border: 'none', width: '100%' }}>
                                {t.import}
                            </Button>
                        </Upload>
                        <Button 
                            className="custom-btn" 
                            block 
                            icon={<DownloadOutlined />} 
                            onClick={handleExportSelected} 
                            style={{ background: '#27ae60', marginTop: 10, border: 'none', width: '100%' }}
                        >
                            {t.export}
                        </Button>
                        <Button 
                            className="custom-btn" 
                            block 
                            icon={<GroupOutlined />} 
                            onClick={() => {
                                if (checkedFiles.size < 2) return message.warning("Please select at least 2 files");
                                
                                // Fetch columns from the first selected file
                                const firstFile = Array.from(checkedFiles)[0];
                                const hide = message.loading("Loading columns...", 0);
                                fetch(`/api/data/columns?filename=${encodeURIComponent(firstFile)}`)
                                    .then(r => r.json())
                                    .then(res => {
                                        hide();
                                        if (res.columns) {
                                            setAggregateColumns(res.columns);
                                        }
                                        setShowAggregate(true);
                                    })
                                    .catch(err => {
                                        hide();
                                        console.error("Failed to fetch columns", err);
                                        // Still show modal even if columns fail
                                        setShowAggregate(true);
                                    });
                            }} 
                            style={{ background: '#8e44ad', marginTop: 10, border: 'none', width: '100%' }}
                        >
                            {t.aggregate}
                        </Button>
                    </div>

                    <div className="history-list">
                        {files.map(f => (
                            <div 
                                key={f.id} 
                                className={`history-item ${selectedId === f.id ? 'active' : ''}`}
                                onClick={() => handleFileClick(f)}
                                style={{ paddingLeft: f.indent ? `${f.indent * 32 + 12}px` : '12px' }}
                            >
                                <Checkbox 
                                    checked={checkedFiles.has(f.name)}
                                    onChange={(e) => handleCheckboxChange(e, f.name)}
                                    style={{ marginRight: 8 }}
                                    onClick={(e) => e.stopPropagation()}
                                />
                                {f.indent > 0 ? <span style={{marginRight:8, color: '#aaa'}}>↳</span> : <FileTextOutlined style={{ marginRight: 8 }} />}
                                <span title={f.name} style={{overflow:'hidden', textOverflow:'ellipsis', whiteSpace:'nowrap', display:'inline-block', width: f.indent > 0 ? '130px' : '150px', verticalAlign:'middle'}}>
                                    {f.displayName || f.name}
                                </span>
                            </div>
                        ))}
                    </div>

                    <div className="history-footer">
                        <Button className="custom-btn btn-danger" block icon={<DeleteOutlined />} onClick={handleDeleteSelected}>{t.clear}</Button>
                        <Button className="custom-btn btn-orange" block icon={<GlobalOutlined />} onClick={() => setLang(lang === 'en' ? 'cn' : 'en')}>{t.lang}</Button>
                    </div>

                    <Modal
                        title={t.aggregate_title}
                        open={showAggregate}
                        onCancel={() => setShowAggregate(false)}
                        onOk={() => {
                            if (!aggregateOutputName) return message.error("Filename required");
                            const hide = message.loading(t.aggregating, 0);
                            fetch('/api/data/aggregate', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    filenames: Array.from(checkedFiles),
                                    dedup_col: aggregateDedupCol || null,
                                    output_name: aggregateOutputName
                                })
                            })
                            .then(r => r.json())
                            .then(res => {
                                hide();
                                if (res.status === 'success') {
                                    message.success(t.aggregated);
                                    setShowAggregate(false);
                                    fetchFiles();
                                } else {
                                    message.error(res.detail || "Failed");
                                }
                            })
                            .catch(err => {
                                hide();
                                message.error("Error: " + err.message);
                            });
                        }}
                    >
                        <div style={{marginBottom: 16}}>
                            <label style={{display:'block', marginBottom: 8}}>{t.dedup_col}:</label>
                            <Select 
                                placeholder="Select column (optional)" 
                                value={aggregateDedupCol} 
                                onChange={val => setAggregateDedupCol(val)}
                                allowClear
                                style={{ width: '100%' }}
                            >
                                {aggregateColumns.map(col => (
                                    <Option key={col} value={col}>{col}</Option>
                                ))}
                            </Select>
                        </div>
                        <div style={{marginBottom: 16}}>
                            <label style={{display:'block', marginBottom: 8}}>{t.output_name}:</label>
                            <Input 
                                value={aggregateOutputName} 
                                onChange={e => setAggregateOutputName(e.target.value)} 
                            />
                        </div>
                        <div>
                            <Text type="secondary">Selected: {checkedFiles.size} files</Text>
                        </div>
                    </Modal>
                </div>
            );
        };

        // --- Labeling Configuration Component (Control Panel) ---
        const LabelingConfigView = ({ selectedFile, t, lang, onFileCreated, config, taskConfig, onConfigUpdated }) => {
            const [annotator, setAnnotator] = useState("");
            const [loading, setLoading] = useState(false);
            const [taskFields, setTaskFields] = useState([]); 
            const [showFieldModal, setShowFieldModal] = useState(false);
            const [customField, setCustomField] = useState({ name: '', label_cn: '', label_en: '', type: 'text', options: '' });

            // Check if file is a task file
            const isTask = selectedFile && selectedFile.name.split('/').pop().split('\\').pop().startsWith("标注员_");
            
            // Sync taskFields when taskConfig changes (and we are in task mode)
            useEffect(() => {
                if (isTask && taskConfig) {
                    setTaskFields(taskConfig);
                } else if (!isTask) {
                     setTaskFields([]);
                }
            }, [taskConfig, isTask]);

            const openModal = () => setShowFieldModal(true);

            const handleCreate = () => {
                if (!annotator.trim()) return message.error("Please enter annotator name");
                setLoading(true);
                
                fetch('/api/label/task/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        annotator: annotator,
                        filename: selectedFile.name,
                        source_type: 'video',
                        custom_fields: taskFields
                    })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        onFileCreated(res.new_filename);
                    } else {
                        message.error(res.detail || "Failed");
                    }
                })
                .catch(e => {
                    setLoading(false);
                    message.error(e.message);
                });
            };

            const handleUpdateConfig = () => {
                setLoading(true);
                fetch('/api/label/task/update_config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filename: selectedFile.name,
                        fields: taskFields
                    })
                })
                .then(r => r.json())
                .then(res => {
                    setLoading(false);
                    if (res.status === 'success') {
                        message.success("Configuration updated!");
                        if (onConfigUpdated) onConfigUpdated();
                    } else {
                        message.error(res.detail || "Failed");
                    }
                })
                .catch(e => {
                    setLoading(false);
                    message.error(e.message);
                });
            };

            const addCustomField = () => {
                if (!customField.name) return message.error("Key required");
                
                if (taskFields.some(f => f.name === customField.name) || (config && config.some(f => f.name === customField.name))) {
                     return message.error("Field key already exists");
                }

                const newF = {
                    name: customField.name,
                    label_cn: customField.label_cn || customField.name,
                    label_en: customField.label_en || customField.name,
                    type: customField.type,
                    options: customField.options ? customField.options.split(',').map(s=>s.trim()) : [],
                    label: customField.label_cn || customField.name
                };
                
                setTaskFields(prev => [...prev, newF]);
                setCustomField({ name: '', label_cn: '', label_en: '', type: 'text', options: '' });
                message.success("Custom field added");
            };

            return (
                <div>
                    <Title level={5}>{t.lbl_title}</Title>
                    <div style={{marginBottom: 10, fontSize: 12, color: '#888'}}>
                        {isTask ? `Current Task: ${selectedFile.name}` : `Target: ${selectedFile ? selectedFile.name : "None"}`}
                    </div>
                    {selectedFile ? (
                        <>
                        {!isTask && (
                            <Form layout="vertical">
                                <Form.Item label={t.lbl_annotator_name} required>
                                    <Input value={annotator} onChange={e => setAnnotator(e.target.value)} placeholder={t.lbl_enter_name_placeholder} />
                                </Form.Item>
                            </Form>
                        )}
                        
                        <div style={{ marginBottom: 20, border: '1px solid #eee', padding: 10, borderRadius: 4 }}>
                            <div style={{ fontWeight: 'bold', marginBottom: 10, display: 'flex', justifyContent: 'space-between' }}>
                                <span>{t.lbl_field_config}</span>
                                <Button size="small" onClick={openModal} icon={<SettingOutlined />}>Configure</Button>
                            </div>
                            <div style={{ maxHeight: 300, overflowY: 'auto' }}>
                                {taskFields.length === 0 && <div style={{color:'#ccc', fontStyle:'italic'}}>{t.lbl_no_fields}</div>}
                                {taskFields.map((f, i) => (
                                    <div key={`field-${i}`} style={{ padding: '4px 0', display: 'flex', justifyContent: 'space-between', borderBottom:'1px dashed #eee' }}>
                                        <span>
                                            <Tag color={f.label_key ? "blue" : "green"}>{f.label_key ? t.lbl_preset : t.lbl_custom}</Tag> 
                                            <span style={{marginLeft: 6}}>
                                                {(() => {
                                                    if (f.label_key && t[f.label_key]) return t[f.label_key];
                                                    const lbl = lang === 'cn' ? f.label_cn : f.label_en;
                                                    return lbl || f.label || f.name;
                                                })()}
                                            </span>
                                        </span>
                                        <DeleteOutlined 
                                            style={{ color: 'red', cursor: 'pointer' }} 
                                            onClick={() => {
                                                const newFields = [...taskFields];
                                                newFields.splice(i, 1);
                                                setTaskFields(newFields);
                                            }} 
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {isTask ? (
                            <Button type="primary" onClick={handleUpdateConfig} loading={loading} block style={{ background: '#e67e22', borderColor: '#e67e22' }}>
                                Update Configuration
                            </Button>
                        ) : (
                            <Button type="primary" onClick={handleCreate} loading={loading} block style={{ background: '#2ecc71', borderColor: '#2ecc71' }}>
                                {t.lbl_start_labeling}
                            </Button>
                        )}
                        
                        <Modal 
                            title={t.lbl_field_config}
                            open={showFieldModal} 
                            onOk={() => setShowFieldModal(false)} 
                            onCancel={() => setShowFieldModal(false)}
                            width={900}
                        >
                            <div style={{display:'flex', height: 500, gap: 20}}>
                                {/* Left: Presets */}
                                <div style={{width: 250, borderRight: '1px solid #eee', paddingRight: 10, overflowY:'auto'}}>
                                    <div style={{fontWeight:'bold', marginBottom:10}}>{t.lbl_select_preset}</div>
                                    <Space direction="vertical" style={{width:'100%'}}>
                                    {config.map((f, i) => {
                                        const isSelected = taskFields.some(tf => tf.name === f.name);
                                        return (
                                            <div key={i} style={{marginBottom: 5}}>
                                                <Checkbox 
                                                    checked={isSelected}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            if (!isSelected) setTaskFields([...taskFields, f]);
                                                        } else {
                                                            setTaskFields(taskFields.filter(tf => tf.name !== f.name));
                                                        }
                                                    }}
                                                >
                                                    {f.label_key ? t[f.label_key] : f.name}
                                                </Checkbox>
                                            </div>
                                        );
                                    })}
                                    </Space>
                                </div>
                                
                                {/* Right: Active List & Custom */}
                                <div style={{flex: 1, display:'flex', flexDirection:'column'}}>
                                    <div style={{fontWeight:'bold', marginBottom:10}}>{t.lbl_selected_fields}</div>
                                    <div style={{flex: 1, overflow: 'auto', marginBottom: 20, border:'1px solid #eee', borderRadius:4}}>
                                        <Table 
                                            dataSource={taskFields}
                                            rowKey="name"
                                            pagination={false}
                                            size="small"
                                            columns={[
                                                { title: t.lbl_name, dataIndex: 'name', width: 100 },
                                                { title: t.lbl_type, dataIndex: 'type', width: 80, render: (v) => {
                                                    if (v === 'text') return t.lbl_type_text;
                                                    if (v === 'single') return t.lbl_type_single;
                                                    if (v === 'multi') return t.lbl_type_multi;
                                                    return v;
                                                }},
                                                { title: t.lbl_label_cn, dataIndex: 'label_cn', width: 100, render: (v, r) => v || r.label || '-' },
                                                { title: t.lbl_label_en, dataIndex: 'label_en', width: 100, render: (v, r) => v || '-' },
                                                { 
                                                    title: t.lbl_action, 
                                                    width: 60,
                                                    render: (_, r, idx) => (
                                                        <Button type="text" danger size="small" icon={<DeleteOutlined />} onClick={() => {
                                                            const n = [...taskFields];
                                                            n.splice(idx, 1);
                                                            setTaskFields(n);
                                                        }} />
                                                    )
                                                }
                                            ]}
                                        />
                                    </div>

                                    <div style={{borderTop: '1px solid #eee', paddingTop: 15}}>
                                        <div style={{fontWeight:'bold', marginBottom:10}}>{t.lbl_create_custom}</div>
                                        <div style={{display:'flex', gap: 10, marginBottom: 10}}>
                                            <Input 
                                                placeholder={t.lbl_name + " (Key)"} 
                                                value={customField.name} 
                                                onChange={e => setCustomField({...customField, name: e.target.value})} 
                                                style={{width: 200}}
                                            />
                                            <Select 
                                                value={customField.type} 
                                                onChange={v => setCustomField({...customField, type: v})}
                                                style={{width: 150}}
                                            >
                                                <Option value="text">{t.lbl_type_text}</Option>
                                                <Option value="single">{t.lbl_type_single}</Option>
                                                <Option value="multi">{t.lbl_type_multi}</Option>
                                            </Select>
                                        </div>
                                        <div style={{display:'flex', gap: 10, marginBottom: 10}}>
                                            <Input 
                                                placeholder={t.lbl_label_cn} 
                                                value={customField.label_cn} 
                                                onChange={e => setCustomField({...customField, label_cn: e.target.value})} 
                                                style={{flex: 1}}
                                            />
                                            <Input 
                                                placeholder={t.lbl_label_en} 
                                                value={customField.label_en} 
                                                onChange={e => setCustomField({...customField, label_en: e.target.value})} 
                                                style={{flex: 1}}
                                            />
                                        </div>
                                        <div style={{display:'flex', gap: 10}}>
                                            <Input 
                                                placeholder={t.lbl_options} 
                                                value={customField.options} 
                                                onChange={e => setCustomField({...customField, options: e.target.value})} 
                                                disabled={customField.type === 'text'}
                                                style={{flex: 1}}
                                            />
                                            <Button type="primary" icon={<PlusOutlined />} onClick={addCustomField}>{t.lbl_add_field}</Button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </Modal>
                        </>
                    ) : <Empty description="Select a file to start" />}
                </div>
            );
        };

        // --- Settings Modal Component ---
        const SettingsModal = ({ visible, onClose, config, onSave, t }) => {
            const [form] = Form.useForm();
            const [picking, setPicking] = useState(false);
            const [currentPath, setCurrentPath] = useState("");
            
            // Check data_root_path first, then legacy video_save_path
            const isConfigured = config && (config.data_root_path || config.video_save_path);
            const canClose = !!isConfigured;

            // Helper to format display path
            const getDisplayPath = (rootPath) => {
                if (!rootPath) return "";
                // Guess separator based on input or default to backslash for Windows
                const sep = rootPath.includes("/") ? "/" : "\\";
                // Avoid double separator if root ends with one
                const cleanRoot = rootPath.endsWith(sep) ? rootPath.slice(0, -1) : rootPath;
                return `${cleanRoot}${sep}AI4ResearchDatabase`;
            };

            useEffect(() => {
                if (visible && config) {
                    // Map data_root_path to form field, fallback to video_save_path
                    const path = config.data_root_path || config.video_save_path || "";
                    form.setFieldsValue({ data_root_path: path });
                    setCurrentPath(getDisplayPath(path));
                }
            }, [visible, config]);

            const handleOk = () => {
                form.validateFields().then(values => {
                    // Backend expects 'data_root_path' now
                    onSave(values);
                });
            };

            const handlePickFolder = () => {
                setPicking(true);
                fetch('/api/data/system/pick_folder')
                    .then(r => r.json())
                    .then(res => {
                        setPicking(false);
                        if (res.path) {
                            form.setFieldsValue({ data_root_path: res.path });
                            setCurrentPath(getDisplayPath(res.path));
                        }
                    })
                    .catch(e => {
                        setPicking(false);
                        message.error("Failed to open directory picker: " + e);
                    });
            };
            
            const handleOpenFolder = (path) => {
                if (!path) return;
                fetch('/api/data/system/open_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                }).catch(e => message.error("Failed to open folder: " + e));
            };

            return (
                <Modal
                    title={t.lbl_settings_title}
                    open={visible}
                    onOk={handleOk}
                    onCancel={canClose ? onClose : undefined}
                    maskClosable={canClose}
                    keyboard={canClose}
                    closable={canClose}
                    footer={[
                        <Button key="submit" type="primary" onClick={handleOk}>
                            {t.lbl_save}
                        </Button>
                    ]}
                >
                    <Form form={form} layout="vertical">
                        <Form.Item 
                            label={t.lbl_video_path} 
                            help={t.lbl_video_path_help}
                            required
                        >
                             <div style={{ display: 'flex', alignItems: 'center', gap: '8px', border: '1px solid #d9d9d9', borderRadius: '6px', padding: '4px 11px' }}>
                                <div style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                    {currentPath ? (
                                        <a onClick={() => handleOpenFolder(currentPath)} title={currentPath}>
                                            {currentPath}
                                        </a>
                                    ) : (
                                        <span style={{ color: '#bfbfbf' }}>{t.lbl_select_folder}...</span>
                                    )}
                                </div>
                                <Button size="small" onClick={handlePickFolder} loading={picking}>
                                    {t.lbl_select_folder}
                                </Button>
                             </div>
                             {/* Hidden field for validation/submission */}
                             <Form.Item name="data_root_path" noStyle rules={[{ required: true, message: t.lbl_folder_required }]}>
                                <Input type="hidden" />
                             </Form.Item>
                        </Form.Item>
                    </Form>
                </Modal>
            );
        };

        const RowPreviewView = ({ activeRow, t, lang }) => {
            const [playbackRate, setPlaybackRate] = useState(1.0);
            const videoRef = useRef(null);
            
            if (!activeRow) {
                return <Empty description={t.ws_lbl_desc} style={{marginTop: 50}} />;
            }
            
            const videoUrl = activeRow.data.video_url || activeRow.data.url || activeRow.data.Video_Url;
            const isDownloaded = activeRow.data._downloaded;

            const handleRateChange = (rate) => {
                setPlaybackRate(rate);
                if (videoRef.current) {
                    videoRef.current.playbackRate = rate;
                }
            };
            const title = activeRow.data.title || activeRow.data.Title || `Row ${activeRow.index + 1}`;
            const author = activeRow.data.author_name || activeRow.data.author || activeRow.data.Author;
            const platform = activeRow.data.platform || activeRow.data.Platform;

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                    {videoUrl && (
                        <div style={{ marginBottom: 15, background: '#000', borderRadius: 4, overflow: 'hidden', flexShrink: 0 }}>
                            {isDownloaded ? (
                                <>
                                    <video 
                                        ref={videoRef}
                                        src={`/api/data/video/download_url?url=${encodeURIComponent(videoUrl)}`} 
                                        controls 
                                        autoPlay 
                                        style={{ width: '100%', maxHeight: '300px', display: 'block' }} 
                                        onCanPlay={() => {
                                            if(videoRef.current) videoRef.current.playbackRate = playbackRate;
                                        }}
                                    />
                                    <div style={{ padding: '5px 10px', background: '#333', display: 'flex', alignItems: 'center', gap: 10 }}>
                                        <span style={{ color: '#fff', fontSize: 12 }}>Speed:</span>
                                        <Radio.Group 
                                            value={playbackRate} 
                                            onChange={e => handleRateChange(e.target.value)} 
                                            size="small"
                                            buttonStyle="solid"
                                        >
                                            <Radio.Button value={0.5}>0.5x</Radio.Button>
                                            <Radio.Button value={1.0}>1.0x</Radio.Button>
                                            <Radio.Button value={1.5}>1.5x</Radio.Button>
                                            <Radio.Button value={2.0}>2.0x</Radio.Button>
                                        </Radio.Group>
                                    </div>
                                </>
                            ) : (
                                <div style={{ padding: 30, textAlign: 'center', background: '#f5f5f5', color: '#666' }}>
                                    <div style={{ marginBottom: 10 }}>Video not downloaded</div>
                                    <Button type="primary" onClick={() => window.open(videoUrl, '_blank')}>
                                        Open Original Page
                                    </Button>
                                </div>
                            )}
                        </div>
                    )}
                    <div style={{ fontWeight: 'bold', marginBottom: 10, borderBottom: '1px solid #eee', paddingBottom: 5, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }} title={title}>
                        {title}
                    </div>
                    <div style={{ fontSize: 12, color: '#555', lineHeight: 1.6 }}>
                        {platform && <div>Platform: {platform}</div>}
                        {author && <div>Author: {author}</div>}
                    </div>
                </div>
            );
        };

        // --- Labeling Form Component (Right Workspace) ---
        const LabelingFormView = ({ activeRow, onSave, config, t, lang }) => {
            const [playbackRate, setPlaybackRate] = useState(1.0);
            const videoRef = useRef(null);
            
            if (!activeRow) {
                return <Empty description="Select a row to label" style={{marginTop: 50}} />;
            }
            
            const videoUrl = activeRow.data.video_url || activeRow.data.url || activeRow.data.Video_Url;
            const isDownloaded = activeRow.data._downloaded;
            
            const handleRateChange = (rate) => {
                setPlaybackRate(rate);
                if (videoRef.current) {
                    videoRef.current.playbackRate = rate;
                }
            };

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                     {/* Integrated Video Player */}
                     {videoUrl && (
                        <div style={{ marginBottom: 15, background: '#000', borderRadius: 4, overflow: 'hidden', flexShrink: 0 }}>
                            {isDownloaded ? (
                                <>
                                    <video 
                                        ref={videoRef}
                                        src={`/api/data/video/download_url?url=${encodeURIComponent(videoUrl)}`} 
                                        controls 
                                        autoPlay 
                                        style={{ width: '100%', maxHeight: '300px', display: 'block' }} 
                                        onCanPlay={() => {
                                            if(videoRef.current) videoRef.current.playbackRate = playbackRate;
                                        }}
                                    />
                                    <div style={{ padding: '5px 10px', background: '#333', display: 'flex', alignItems: 'center', gap: 10 }}>
                                        <span style={{ color: '#fff', fontSize: 12 }}>Speed:</span>
                                        <Radio.Group 
                                            value={playbackRate} 
                                            onChange={e => handleRateChange(e.target.value)} 
                                            size="small"
                                            buttonStyle="solid"
                                        >
                                            <Radio.Button value={0.5}>0.5x</Radio.Button>
                                            <Radio.Button value={1.0}>1.0x</Radio.Button>
                                            <Radio.Button value={1.5}>1.5x</Radio.Button>
                                            <Radio.Button value={2.0}>2.0x</Radio.Button>
                                        </Radio.Group>
                                    </div>
                                </>
                            ) : (
                                <div style={{ padding: 30, textAlign: 'center', background: '#f5f5f5', color: '#666' }}>
                                    <div style={{ marginBottom: 10 }}>Video not downloaded</div>
                                    <Button type="primary" onClick={() => window.open(videoUrl, '_blank')}>
                                        Open Original Page
                                    </Button>
                                </div>
                            )}
                        </div>
                     )}

                     <div style={{ fontWeight: 'bold', marginBottom: 10, borderBottom: '1px solid #eee', paddingBottom: 5, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }} title={activeRow.data.title || activeRow.data.Title || `Row ${activeRow.index + 1}`}>
                        Labeling: {activeRow.data.title || activeRow.data.Title || `Row ${activeRow.index + 1}`}
                     </div>
                     <div style={{ flex: 1, overflowY: 'auto' }}>
                        <Form layout="vertical">
                            {config.map((field, i) => {
                                const val = activeRow.data[field.name];
                                const details = activeRow.data[field.name + "_Details"];
                                
                                let displayLabel = field.label || field.name;
                                if (field.label_key && t[field.label_key]) {
                                    displayLabel = t[field.label_key];
                                } else {
                                    if (lang === 'cn' && field.label_cn) displayLabel = field.label_cn;
                                    else if (lang === 'en' && field.label_en) displayLabel = field.label_en;
                                }
                                
                                return (
                                    <div key={i} style={{ marginBottom: 15, padding: 10, background: '#f9f9f9', borderRadius: 4 }}>
                                        <div style={{ fontWeight: 'bold', marginBottom: 5 }}>{displayLabel}</div>
                                        
                                        {field.type === 'text' && (
                                            <Input.TextArea 
                                                rows={3} 
                                                value={val || ''} 
                                                onChange={e => onSave(field.name, e.target.value)} 
                                            />
                                        )}
                                        
                                        {field.type === 'single' && (
                                            <Radio.Group 
                                                onChange={e => {
                                                    let v = e.target.value;
                                                    // Attempt to convert back to number if it was a score field
                                                    if (field.scores && !isNaN(Number(v))) {
                                                        v = Number(v);
                                                    }
                                                    onSave(field.name, v);
                                                }} 
                                                value={val != null && val !== "" ? (field.scores && !isNaN(Number(val)) ? String(Number(val)) : String(val)) : undefined}
                                            >
                                                <Space direction="vertical">
                                                    {field.options.map((opt, idx) => {
                                                        const valToSend = field.scores ? (field.scores[idx] !== undefined ? field.scores[idx] : field.scores[String(idx)]) : opt;
                                                        return <Radio key={idx} value={String(valToSend)}>{opt}</Radio>;
                                                    })}
                                                </Space>
                                            </Radio.Group>
                                        )}
                                        
                                        {field.type === 'multi' && (
                                            <Checkbox.Group 
                                                style={{ width: '100%' }}
                                                value={details ? String(details).split(';') : []}
                                                onChange={(checkedValues) => {
                                                    const detailStr = checkedValues.join(';');
                                                    onSave(field.name, checkedValues.length, detailStr);
                                                }}
                                            >
                                                <Space direction="vertical">
                                                    {field.options.map((opt, idx) => (
                                                        <Checkbox key={idx} value={opt}>{opt}</Checkbox>
                                                    ))}
                                                </Space>
                                            </Checkbox.Group>
                                        )}
                                    </div>
                                );
                            })}
                        </Form>
                     </div>
                </div>
            );
        };

        // --- Control Panel Component (Center) ---
        const ControlPanel = ({ activeTab, setActiveTab, children, t }) => {
            const items = [
                { key: 'acquisition', label: t.tab_acq, icon: <CloudUploadOutlined /> },
                { key: 'preprocess', label: t.tab_prep, icon: <SettingOutlined /> },
                { key: 'label', label: t.tab_label, icon: <FileAddOutlined /> },
                { key: 'analysis', label: t.tab_anal, icon: <ExperimentOutlined /> },
                { key: 'plot', label: t.tab_plot, icon: <BarChartOutlined /> },
            ];

            return (
                <div className="col-control">
                    <Tabs 
                        activeKey={activeTab} 
                        onChange={setActiveTab}
                        type="card"
                        className="control-tabs"
                        items={items.map(i => ({
                            key: i.key,
                            label: (<span>{i.icon} {i.label}</span>)
                        }))}
                    />
                    <div className="control-content">
                        {children}
                    </div>
                </div>
            );
        };

        // --- Analysis Panel Component ---
        const AnalysisPanel = ({ selectedFile, t, previewData, currentQuota }) => {
            const [mainCategory, setMainCategory] = useState('difference'); // difference, regression
            const [analysisType, setAnalysisType] = useState('t_test');
            const [loading, setLoading] = useState(false);
            const [form] = Form.useForm();

            // Reset form when type changes
            useEffect(() => {
                form.resetFields();
            }, [analysisType, mainCategory]);

            const analysisOptions = {
                difference: [
                    { value: 't_test', label: '独立样本 T 检验 (Independent T-test)' },
                    { value: 'mann_whitney', label: 'Mann-Whitney U 检验' },
                    { value: 'anova', label: '单因素方差分析 (ANOVA)' },
                    { value: 'kruskal', label: 'Kruskal-Wallis 检验' },
                    { value: 'paired_t', label: '配对 T 检验 (Paired T-test)' },
                    { value: 'wilcoxon', label: 'Wilcoxon 符号秩检验' },
                    { value: 'rm_anova', label: '重复测量 ANOVA' },
                    { value: 'friedman', label: 'Friedman 检验' }
                ],
                regression: [
                    { value: 'correlation', label: '相关性分析 (Correlation)' },
                    { value: 'chi_square', label: '卡方检验 (Chi-square)' },
                    { value: 'linear_regression', label: '线性回归 (Linear Regression)' },
                    { value: 'logistic_regression', label: '二元逻辑回归 (Logistic Regression)' },
                    { value: 'ordinal_regression', label: '有序逻辑回归 (Ordinal Regression)' },
                    { value: 'lmm', label: '线性混合模型 (LMM)' }
                ]
            };

            const usageDocs = {
                t_test: { req: "比较两组独立对象的均值。要求数据正态且方差齐。", ex: "实验组 vs 对照组血压差异" },
                mann_whitney: { req: "独立 T 检验非参数版。适用于不正态或等级数据。", ex: "两组患者护理满意度等级" },
                anova: { req: "比较三组或以上均值。要求正态且方差齐。", ex: "三种饮食对体重的降幅" },
                kruskal: { req: "ANOVA 非参数版。", ex: "三城市空气质量评分" },
                paired_t: { req: "比较同一组对象前后差异。差值需正态。", ex: "培训前后成绩变化" },
                wilcoxon: { req: "配对 T 检验非参数版。", ex: "两评委对同一选手打分" },
                rm_anova: { req: "同一组对象多时间点比较。需满足球形性假设。", ex: "治疗后1、2、4周康复指标" },
                friedman: { req: "重复测量 ANOVA 非参数版。", ex: "三款APP用户体验评分" },
                correlation: { req: "两个连续变量共变关系。", ex: "气温与销量相关性" },
                chi_square: { req: "两个分类变量关联。", ex: "性别与吸烟关联" },
                linear_regression: { req: "连续变量间线性关系。自动计算VIF。", ex: "广告投入对销售额影响" },
                logistic_regression: { req: "二分类结果影响因素。", ex: "预测贷款违约" },
                ordinal_regression: { req: "有序分类结果。需满足比例优势假设。", ex: "学历对工作满意度影响" },
                lmm: { req: "层级数据。需区分固定效应和随机效应。", ex: "教学法对成绩影响（班级为随机效应）" }
            };

            const handleRun = async (values) => {
                if (!selectedFile) return message.error("Please select a file first");
                
                // Check Quota
                if (currentQuota && currentQuota.balance_analyze <= 0) {
                     Modal.error({
                        title: t.quota_exhausted,
                        content: t.quota_analyze_exhausted_msg
                     });
                     return;
                }

                setLoading(true);
                
                const formData = new FormData();
                formData.append('filename', selectedFile.name);
                formData.append('analysis_type', analysisType);
                formData.append('params', JSON.stringify(values));

                try {
                    const res = await fetch('/api/analysis/run', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.error) {
                        message.error(data.error);
                    } else {
                        // Render Result
                        const container = document.getElementById('analysis-results');
                        if (container) {
                            if (data.html) {
                                container.innerHTML = data.html;
                            } else {
                                container.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                            }
                        }
                        message.success("Analysis complete! Report saved.");
                    }
                } catch (e) {
                    message.error("Analysis failed: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const cols = previewData?.columns || [];

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: 15 }}>
                    {/* Level 1: Category */}
                    <Radio.Group 
                        value={mainCategory} 
                        onChange={e => {
                            setMainCategory(e.target.value);
                            setAnalysisType(analysisOptions[e.target.value][0].value);
                        }}
                        buttonStyle="solid"
                    >
                        <Radio.Button value="difference">差异分析类</Radio.Button>
                        <Radio.Button value="regression">回归与关系类</Radio.Button>
                    </Radio.Group>

                    {/* Level 2: Method */}
                    <Select value={analysisType} onChange={setAnalysisType} style={{ width: '100%' }}>
                        {analysisOptions[mainCategory].map(opt => (
                            <Option key={opt.value} value={opt.value}>{opt.label}</Option>
                        ))}
                    </Select>

                    {/* Usage Info */}
                    <div style={{ background: '#f0f2f5', padding: 10, borderRadius: 4, fontSize: 12 }}>
                        <div><strong>使用要求:</strong> {usageDocs[analysisType]?.req}</div>
                        <div><strong>示例:</strong> {usageDocs[analysisType]?.ex}</div>
                    </div>

                    {/* Dynamic Form */}
                    <Form form={form} layout="vertical" onFinish={handleRun}>
                        
                        {/* Difference Analysis Forms */}
                        {['t_test', 'mann_whitney', 'anova', 'kruskal'].includes(analysisType) && (
                            <>
                                <Form.Item name="group_col" label="分组列 (Group Column)" rules={[{required:true}]}>
                                    <Select showSearch optionFilterProp="children"><Option value="None">None</Option>{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                <Form.Item name="value_cols" label="数值列 (Value Columns)" rules={[{required:true}]}>
                                    <Select mode="multiple" showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                <Form.Item name="tendency" label="中心趋势" initialValue={['t_test', 'anova'].includes(analysisType) ? 'mean' : 'median'}>
                                    <Select>
                                        <Option value="mean">均值 ± 标准差 (Mean ± SD)</Option>
                                        <Option value="median">中位数 (IQR)</Option>
                                    </Select>
                                </Form.Item>
                            </>
                        )}

                        {['paired_t', 'wilcoxon'].includes(analysisType) && (
                            <>
                                <Form.Item name="col1" label="变量 1 (Variable 1)" rules={[{required:true}]}>
                                    <Select showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                <Form.Item name="col2" label="变量 2 (Variable 2)" rules={[{required:true}]}>
                                    <Select showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                            </>
                        )}

                        {['rm_anova', 'friedman'].includes(analysisType) && (
                            <Form.Item name="value_cols" label="重复测量列 (Repeated Measures Columns)" rules={[{required:true}]}>
                                <Select mode="multiple" showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                            </Form.Item>
                        )}

                        {/* Regression Forms */}
                        {analysisType === 'correlation' && (
                            <>
                                <Form.Item name="value_cols" label="分析列 (Columns)" rules={[{required:true}]}>
                                    <Select mode="multiple" showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                <Form.Item name="method" label="方法 (Method)" initialValue="pearson">
                                    <Select>
                                        <Option value="pearson">Pearson (正态)</Option>
                                        <Option value="spearman">Spearman (非正态)</Option>
                                        <Option value="kendall">Kendall (小样本)</Option>
                                    </Select>
                                </Form.Item>
                            </>
                        )}

                        {analysisType === 'chi_square' && (
                            <>
                                <Form.Item name="row_var" label="行变量 (Row Variable)" rules={[{required:true}]}>
                                    <Select showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                <Form.Item name="col_var" label="列变量 (Column Variable)" rules={[{required:true}]}>
                                    <Select showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                            </>
                        )}

                        {['linear_regression', 'logistic_regression', 'ordinal_regression', 'lmm'].includes(analysisType) && (
                            <>
                                <Form.Item name="y_col" label="因变量 Y (Dependent Variable)" rules={[{required:true}]}>
                                    <Select showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                <Form.Item name="x_cols" label={analysisType === 'lmm' ? "固定效应 X (Fixed Effects)" : "自变量 X (Independent Variables)"} rules={[{required:true}]}>
                                    <Select mode="multiple" showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                </Form.Item>
                                {analysisType === 'lmm' && (
                                    <Form.Item name="group_col" label="随机分组 (Random Group)" rules={[{required:true}]}>
                                        <Select showSearch optionFilterProp="children">{cols.map(c=><Option key={c} value={c}>{c}</Option>)}</Select>
                                    </Form.Item>
                                )}
                            </>
                        )}

                        <Button type="primary" htmlType="submit" loading={loading} block style={{ background: '#3498db' }}>
                            开始分析 (Run Analysis)
                        </Button>
                    </Form>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('acquisition'); 
            const [selectedFile, setSelectedFile] = useState(null);
            
            // Auth State
            const [currentUser, setCurrentUser] = useState(null);
            const [currentQuota, setCurrentQuota] = useState(null);
            const [loginModalVisible, setLoginModalVisible] = useState(false);
            const [checkingAuth, setCheckingAuth] = useState(true);

            useEffect(() => {
                // Bind Auth callbacks
                if (window.Auth) {
                    window.Auth.onUserChange = (user) => {
                    setCurrentUser(user);
                    setCheckingAuth(false);
                    if (user) {
                        fetch('/api/data/config')
                            .then(r => r.json())
                            .then(cfg => {
                                setSysConfig(cfg);
                                if (!cfg.data_root_path && !cfg.video_save_path) {
                                    setSettingsVisible(true);
                                    message.warning(t.lbl_folder_required);
                                }
                            });
                    }
                };
                    window.Auth.onQuotaChange = setCurrentQuota;
                    
                    // Initial check
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        setCheckingAuth(false);
                    } else {
                        window.Auth.init();
                    }
                }
            }, []);

            // Settings State
            const [settingsVisible, setSettingsVisible] = useState(false);
            const [contactVisible, setContactVisible] = useState(false);
            const [sysConfig, setSysConfig] = useState({});

            // Load config on mount
            useEffect(() => {
                fetch('/api/data/config')
                    .then(r => r.json())
                    .then(cfg => {
                        setSysConfig(cfg);
                        // Check data_root_path first, then legacy
                        if (!cfg.data_root_path && !cfg.video_save_path) {
                            setSettingsVisible(true);
                        }
                    })
                    .catch(e => console.error("Config load error", e));
            }, []);

            const handleSaveSettings = (values) => {
                fetch('/api/data/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(values)
                })
                .then(r => r.json())
                .then(res => {
                    if(res.status === 'success') {
                        setSysConfig(values);
                        setSettingsVisible(false);
                        message.success("Settings saved");
                    } else {
                        message.error("Failed to save settings");
                    }
                });
            };
            
            // Language State
            const [lang, setLang] = useState(localStorage.getItem('app_lang') || 'en');
            useEffect(() => {
                localStorage.setItem('app_lang', lang);
            }, [lang]);

            const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];

            // State for Modules
            const [crawlLogs, setCrawlLogs] = useState([]);
            const [isCrawling, setIsCrawling] = useState(false);
            const [cookieStatus, setCookieStatus] = useState(null); // { exists: bool }
            const [plotData, setPlotData] = useState(null);
            const [plotImage, setPlotImage] = useState(null);
            const [previewData, setPreviewData] = useState(null);
            const [columns, setColumns] = useState([]); // Store columns for resizing
            const [crawlForm] = Form.useForm();
            const [plotForm] = Form.useForm();
            const [preprocessOriginFile, setPreprocessOriginFile] = useState(null);
            const [preprocessReset, setPreprocessReset] = useState(false);
            const [colRenames, setColRenames] = useState([]);

            // Version State
            const [versionInfo, setVersionInfo] = useState({
                current_version: 'V1.0.0',
                latest_version: null,
                has_update: false,
                status: 'idle',
                progress: 0,
                message: ''
            });

            const checkUpdate = (manual = false) => {
                if (manual) message.loading("Checking for updates...", 0.5);
                fetch('/api/version/check')
                    .then(r => r.json())
                    .then(data => {
                        setVersionInfo(prev => ({ ...prev, ...data }));
                        if (manual) {
                            if (data.has_update) {
                                message.success("New version found!");
                            } else {
                                message.info("You are using the latest version.");
                            }
                        }
                    })
                    .catch(err => {
                        console.error("Update check failed", err);
                        if (manual) message.error("Check failed");
                    });
            };

            const startDownload = () => {
                fetch('/api/version/download', { method: 'POST' })
                    .then(r => r.json())
                    .then(res => {
                        if (res.status === 'started' || res.status === 'already_downloading') {
                            message.info("Download started in background...");
                            pollStatus();
                        }
                    });
            };

            const pollStatus = () => {
                const timer = setInterval(() => {
                    fetch('/api/version/status')
                        .then(r => r.json())
                        .then(data => {
                            setVersionInfo(prev => ({ ...prev, ...data }));
                            if (data.status === 'ready_to_install' || data.status === 'error') {
                                clearInterval(timer);
                            }
                        })
                        .catch(err => {
                            console.error("Status poll failed", err);
                            clearInterval(timer);
                        });
                }, 2000);
            };

            const handleRestart = () => {
                Modal.confirm({
                    title: 'Restart to Apply Update?',
                    content: 'The application will close. Please restart it manually to complete the update.',
                    onOk: () => {
                        fetch('/api/version/restart', { method: 'POST' })
                            .then(() => {
                                message.success("Exiting application...");
                                setTimeout(() => window.close(), 1000);
                            });
                    }
                });
            };

            useEffect(() => {
                checkUpdate();
            }, []);
            const [editingColKey, setEditingColKey] = useState(null);
            const [deletedCols, setDeletedCols] = useState([]);
            const [dragColKey, setDragColKey] = useState(null);
            const [cellEdits, setCellEdits] = useState([]);
            const [editingCell, setEditingCell] = useState(null);
            
            // Labeling State
            const [activeLabelRow, setActiveLabelRow] = useState(null);
            const [labelConfig, setLabelConfig] = useState([]);
            const [taskConfig, setTaskConfig] = useState([]); // Config for the specific selected task
            const [viewVideoUrl, setViewVideoUrl] = useState(null);

            // AI Interpretation State
            const [interpreting, setInterpreting] = useState(false);
            const [interpretResult, setInterpretResult] = useState("");
            // API Key is now managed by server
            const [researchGoal, setResearchGoal] = useState("");
            const [varDefs, setVarDefs] = useState("");

            const handleInterpretation = async () => {
                if (!selectedFile) return message.error("Please select a file first");
                
                // Check Quota
                if (currentQuota && currentQuota.balance_interpret <= 0) {
                     Modal.error({
                        title: t.quota_exhausted,
                        content: t.quota_interpret_exhausted_msg
                     });
                     return;
                }

                // Get current plot form values
                const plotValues = plotForm.getFieldsValue();
                
                setInterpreting(true);
                setInterpretResult(""); // Clear previous
                
                try {
                    const reqBody = {
                        plot_config: {
                            filename: selectedFile.name,
                            ...plotValues
                        },
                        research_goal: researchGoal,
                        variable_definitions: varDefs
                    };
                    
                    const response = await fetch('/api/interpret/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reqBody)
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.detail || "Interpretation failed");
                    }
                    
                    // Handle Stream
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        const chunk = decoder.decode(value, {stream: true});
                        setInterpretResult(prev => prev + chunk);
                    }
                    
                } catch (e) {
                    message.error(e.message);
                    setInterpretResult(prev => prev + "\n\nError: " + e.message);
                } finally {
                    setInterpreting(false);
                }
            };

            // Fetch Label Config
            useEffect(() => {
                fetch('/api/label/config?source_type=video')
                    .then(r => r.json())
                    .then(setLabelConfig);
            }, []);

            // Fetch Task Config when task selected
            useEffect(() => {
                if (selectedFile && selectedFile.name.split('/').pop().split('\\').pop().startsWith("标注员_")) {
                    fetch(`/api/label/task/config?filename=${encodeURIComponent(selectedFile.name)}`)
                        .then(r => r.json())
                        .then(cfg => {
                            console.log("Loaded task config:", cfg);
                            setTaskConfig(cfg);
                        })
                        .catch(err => console.error("Failed to load task config", err));
                } else {
                    setTaskConfig([]);
                }
            }, [selectedFile]);


            const handleColumnRename = (oldName, newName) => {
                if (!newName || !newName.trim() || oldName === newName) return;
                
                // Update columns state locally
                setColumns(prev => prev.map(col => {
                    if (col.dataIndex === oldName) {
                         return {
                             ...col,
                             title: (
                                <EditableTitle 
                                    value={newName} 
                                    onSave={(val) => handleColumnRename(oldName, val)} 
                                />
                            )
                         };
                    }
                    return col;
                }));

                // Update colRenames for backend
                setColRenames(prev => {
                    const existingIndex = prev.findIndex(r => r.from === oldName);
                    if (existingIndex >= 0) {
                        const newRenames = [...prev];
                        newRenames[existingIndex] = { ...newRenames[existingIndex], to: newName };
                        return newRenames;
                    } else {
                        return [...prev, { from: oldName, to: newName }];
                    }
                });
            };

            // Fetch preview when file selected
            useEffect(() => {
                if (selectedFile) {
                    setPreviewData(null); // Clear previous
                    setColumns([]);
                    setActiveLabelRow(null); // Reset label selection
                    setColRenames([]);
                    setDeletedCols([]);
                    setCellEdits([]);
                    setEditingCell(null);
                    
                    console.log("Fetching preview for:", selectedFile.name);
                    fetch(`/api/data/preview?filename=${encodeURIComponent(selectedFile.name)}`)
                        .then(async r => {
                            if (!r.ok) {
                                const text = await r.text();
                                throw new Error(text || r.statusText);
                            }
                            return r.json();
                        })
                        .then(data => {
                            console.log("Preview data received:", data);
                            setPreviewData(data);
                            // Generate initial columns
                            if (data.columns) {
                                const cols = data.columns.map((colName, index) => ({ 
                                    title: (
                                        <EditableTitle 
                                            value={String(colName)} 
                                            onSave={(val) => handleColumnRename(colName, val)} 
                                        />
                                    ),
                                    dataIndex: colName, // Use dataIndex for easier handling, though we use custom render
                                    key: index,
                                    width: colName.toLowerCase() === 'title' ? 300 : 150, // Adjusted width
                                    ellipsis: true,
                                    render: (_, record) => {
                                        try {
                                            const val = record[colName];
                                            const text = val === null || val === undefined ? '' : String(val);
                                            return <span title={text}>{text}</span>;
                                        } catch (e) {
                                            return <span style={{color:'red'}}>Error</span>;
                                        }
                                    }
                                }));
                                setColumns(cols);
                            }
                        })
                        .catch(err => {
                            console.error("Preview failed:", err);
                            message.error(`Failed to load file preview: ${err.message}`);
                            setPreviewData({ error: err.message });
                        });
                } else {
                    setPreviewData(null);
                    setColumns([]);
                }
            }, [selectedFile]);

            const handleResize = (index) => (e, { size }) => {
                setColumns((prevColumns) => {
                    const nextColumns = [...prevColumns];
                    nextColumns[index] = {
                        ...nextColumns[index],
                        width: size.width,
                    };
                    return nextColumns;
                });
            };
            
            // Polling logs
            useEffect(() => {
                let interval;
                if (isCrawling) {
                    interval = setInterval(() => {
                        fetch('/api/crawl/logs')
                            .then(r => {
                                if (!r.ok) throw new Error('Network response was not ok');
                                return r.json();
                            })
                            .then(res => {
                                setCrawlLogs(res.logs);
                                // Relaxed condition: if backend says not running, stop spinning regardless of logs
                                if (!res.running) {
                                    setIsCrawling(false);
                                    // Only show success if it looks like a normal finish, otherwise just stop
                                    if (res.logs.length > 0 && res.logs[res.logs.length-1].includes("Finished")) {
                                        message.success(t.task_finished);
                                    } else {
                                        // Maybe it failed or stopped abruptly, just stop the spinner
                                        console.log("Crawl stopped without 'Finished' log");
                                    }
                                }
                            })
                            .catch(e => {
                                console.error("Polling error:", e);
                            });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isCrawling]);

            // Cookie Check
            const checkCookie = (platform) => {
                fetch(`/api/crawl/cookie_status?platform=${platform}`)
                    .then(r => r.json())
                    .then(setCookieStatus);
            };

            // Init Cookie Check
            useEffect(() => {
                checkCookie('TikTok');
            }, []);

            // Handlers
            const handleCrawlStart = (values) => {
                // Check Quota
                if (currentQuota && currentQuota.balance_crawl <= 0) {
                     Modal.error({
                        title: t.quota_exhausted,
                        content: t.quota_crawl_exhausted_msg
                     });
                     return;
                }

                if (!cookieStatus?.exists) {
                    return message.error("Please upload a cookie file first!");
                }
                setIsCrawling(true);
                fetch('/api/crawl/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(values)
                }).then(r => r.json())
                  .then(res => {
                      if(res.status === 'error') {
                          message.error(res.message);
                          setIsCrawling(false);
                      }
                  });
            };

            const handleCookieUpload = async (file) => {
                const platform = crawlForm.getFieldValue('platform') || 'TikTok';
                const formData = new FormData();
                formData.append('file', file);
                formData.append('platform', platform);
                
                try {
                    const res = await fetch('/api/crawl/upload_cookie', {
                        method: 'POST',
                        body: formData
                    }).then(r => r.json());
                    
                    if (res.status === 'success') {
                        message.success("Cookie uploaded successfully");
                        checkCookie(platform);
                    } else {
                        message.error("Upload failed");
                    }
                } catch(e) {
                    message.error("Upload error");
                }
                return false;
            };

            const handleNetscapeCookieUpload = async (file) => {
                const platform = crawlForm.getFieldValue('platform') || 'TikTok';
                const formData = new FormData();
                formData.append('file', file);
                formData.append('platform', platform);
                
                try {
                    const response = await fetch('/api/crawl/upload_netscape_cookie', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.status === 404) {
                        message.error("Endpoint not found. Please restart the client to apply updates.");
                        return false;
                    }

                    const res = await response.json();
                    
                    if (res.status === 'success') {
                        message.success("Netscape cookie uploaded successfully");
                        checkCookie(platform);
                    } else {
                        message.error("Upload failed: " + (res.detail || "Unknown error"));
                    }
                } catch(e) {
                    message.error("Upload error: " + e.message);
                }
                return false;
            };

            const handlePreprocessRun = (values) => {
                const origin = preprocessOriginFile || selectedFile;
                if (!origin) return message.error("Select a file first");
                
                const payload = { ...values, filename: origin.name, reset: preprocessReset };
                if (payload.target_cols && typeof payload.target_cols === 'string') {
                    payload.target_cols = payload.target_cols.split(/,|，/).map(s => s.trim()).filter(s => s);
                }

                fetch('/api/preprocess/run', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(r => r.json())
                  .then(res => {
                      if (res.status === 'success') {
                          if (!preprocessOriginFile && selectedFile) {
                              setPreprocessOriginFile(selectedFile);
                          }
                          if (preprocessReset) {
                              setPreprocessReset(false);
                              setColRenames([]);
                              setDeletedCols([]);
                              setCellEdits([]);
                              setEditingCell(null);
                          }
                          message.success(t.run_exec);
                          // 使用工作副本刷新预览
                          setPreviewData(null);
                          setColumns([]);
                          setActiveLabelRow(null);
                          if (res.work_file) {
                              setSelectedFile({ name: res.work_file });
                          }
                      } else {
                          message.error(res.detail || "Operation failed");
                      }
                  });
            };

            const handlePreprocessSave = () => {
                const origin = preprocessOriginFile || selectedFile;
                if (!origin) return message.error("Select a file first");
                
                // Use `columns` state for order, as it reflects user drag-and-drop and renames
                const columnOrder = columns.map(c => c.dataIndex);

                fetch('/api/preprocess/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        filename: origin.name,
                        col_renames: colRenames,
                        deleted_cols: deletedCols,
                        column_order: columnOrder,
                        cell_edits: cellEdits
                    })
                }).then(r => r.json())
                  .then(res => {
                      if (res.status === 'success') {
                          message.success(`Created: ${res.new_file}`);
                          setPreviewData(null);
                          setColumns([]);
                          setColRenames([]);
                          setDeletedCols([]);
                          setCellEdits([]);
                          setEditingCell(null);
                          setActiveLabelRow(null);
                          setPreprocessOriginFile({ name: res.new_file });
                          setSelectedFile({ name: res.new_file });
                      } else {
                          message.error(res.detail || "Operation failed");
                      }
                  });
            };

            const handlePlot = (values) => {
                if (!selectedFile) return message.error("Select a file first");

                // Check Quota
                if (currentQuota && currentQuota.balance_visualize <= 0) {
                     Modal.error({
                        title: t.quota_exhausted,
                        content: t.quota_vis_exhausted_msg
                     });
                     return;
                }

                setPlotImage(null);
                const hide = message.loading("Generating...", 0);
                
                // Add format='png' for preview
                const payload = { ...values, filename: selectedFile.name, format: 'png' };
                
                fetch('/api/plot/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(async r => {
                    if (r.ok) return r.blob();
                    const json = await r.json();
                    throw new Error(json.detail || "Error");
                })
                  .then(blob => {
                      hide();
                      const url = URL.createObjectURL(blob);
                      setPlotImage(url);
                      // Clear interactive data if any
                      setPlotData(null); 
                  })
                  .catch(e => {
                      hide();
                      message.error(e.message);
                  });
            };

            const handleExportTiff = () => {
                const values = plotForm.getFieldsValue();
                if (!selectedFile) return message.error("Select a file first");
                
                const hide = message.loading("Exporting TIFF...", 0);
                
                // Add format='tiff' for export
                const payload = { ...values, filename: selectedFile.name, format: 'tiff' };
                
                fetch('/api/plot/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).then(async r => {
                    if (r.ok) return r.blob();
                    const json = await r.json();
                    throw new Error(json.detail || "Error");
                })
                  .then(blob => {
                      hide();
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = `plot_${new Date().getTime()}.tiff`;
                      document.body.appendChild(a);
                      a.click();
                      a.remove();
                      window.URL.revokeObjectURL(url);
                      message.success("Download started");
                  })
                  .catch(e => {
                      hide();
                      message.error(e.message);
                  });
            };

            const handleLabelSave = (field, value, details = null) => {
                if (!selectedFile || !activeLabelRow) return;
                
                const rowIndex = activeLabelRow.index;
                const payload = {
                    filename: selectedFile.name,
                    row_index: rowIndex,
                    data: { [field]: value }
                };
                if (details !== null) {
                    payload.data[field + "_Details"] = details;
                }
                
                // Optimistic Update
                if (previewData && previewData.data) {
                    const newData = [...previewData.data];
                    newData[rowIndex] = { ...newData[rowIndex], ...payload.data };
                    setPreviewData({ ...previewData, data: newData });
                    setActiveLabelRow({ index: rowIndex, data: newData[rowIndex] });
                }
                
                // Server Save
                fetch('/api/label/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                }).catch(e => message.error("Save failed"));
            };

            const handleViewVideo = async (record) => {
                const url = record.video_url || record.url || record.Video_Url;
                if (!url) { message.warning("No URL found"); return; }
                
                try {
                    const res = await fetch(`/api/data/video/check?url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if (data.exists) {
                        setViewVideoUrl(url);
                    } else {
                        // User requested: "Click view default open original link, if downloaded locally then open local"
                        // Since we just checked and it does NOT exist locally, we open original link.
                        window.open(url, '_blank');
                    }
                } catch (e) {
                    window.open(url, '_blank');
                }
            };

            const handleDownloadVideo = (record, filename = "video.mp4") => {
                const url = record.video_url || record.url || record.Video_Url;
                if (!url) return message.warning("No URL found");
                
                // Check if local save path is configured
                if (sysConfig && sysConfig.video_save_path) {
                     const hide = message.loading(`Saving to ${sysConfig.video_save_path}...`, 0);
                     fetch(`/api/data/video/save_local?url=${encodeURIComponent(url)}&filename=${encodeURIComponent(filename)}`)
                        .then(r => r.json())
                        .then(res => {
                            hide();
                            if (res.status === 'success') {
                                message.success(`Saved to: ${res.path}`);
                                // Update state
                                if (previewData && previewData.data) {
                                     const newData = [...previewData.data];
                                     const idx = newData.indexOf(record);
                                     if (idx !== -1) {
                                         newData[idx] = { ...newData[idx], _downloaded: true };
                                         setPreviewData({ ...previewData, data: newData });
                                         if (activeLabelRow && activeLabelRow.index === idx) {
                                             setActiveLabelRow({ index: idx, data: newData[idx] });
                                         }
                                     }
                                }
                            } else {
                                message.error(res.detail || "Save failed");
                            }
                        })
                        .catch(err => {
                            hide();
                            message.error("Save failed: " + err.message);
                        });
                     return;
                }

                const hide = message.loading("Downloading video (this may take a while)...", 0);
                
                fetch(`/api/data/video/download_url?url=${encodeURIComponent(url)}`)
                    .then(response => {
                        if (response.ok) return response.blob();
                        throw new Error("Download failed or timed out");
                    })
                    .then(blob => {
                        const blobUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename; 
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        window.URL.revokeObjectURL(blobUrl);
                        hide();
                        message.success("Download ready");
                        
                        // Update state (assume successful download means we have it, though strictly this is just browser download)
                        // User request: "sync download button and completion flag". 
                        // If it's a browser download, the server might not know it's "downloaded" in the sense of existing on disk for preview.
                        // However, the user might be using the "local save" mode mostly. 
                        // If they use browser download, the file ends up on client, not server.
                        // But for "Labeling Area" playback, the SERVER needs the file.
                        // So "Download" button usually implies "Save to Server" if we want server-side playback.
                        // BUT, the code above has two paths: `save_local` (Server) and `download_url` (Browser).
                        // If `save_local` is used, we mark as downloaded.
                        // If `download_url` is used, it's just a file download to user's PC. Server doesn't have it.
                        // So we should ONLY mark `_downloaded` if `save_local` was used?
                        // The user said "sync download button and completion flag".
                        // If the user downloads to their PC, the server still can't play it in the "Labeling Area" (which uses `/preview` and server path).
                        // So, strictly speaking, `_downloaded` flag only applies to Server-side downloads.
                        // I will add the state update only to the `save_local` path?
                        // Wait, `check?url=...` checks server side.
                        // So yes, only update if `save_local` succeeds.
                        
                    })
                    .catch(err => {
                        hide();
                        message.error(err.message);
                    });
            };

            useEffect(() => {
                if (plotData) {
                    Plotly.newPlot('plotly-div', plotData.data, plotData.layout);
                }
            }, [plotData]);

            // Force Login Check
            if (checkingAuth) {
                return (
                    <div id="app-loading">
                        <div className="spinner"></div>
                        <div style={{marginTop: 20, color: '#666'}}>Verifying session...</div>
                    </div>
                );
            }

            if (!currentUser) {
                return (
                    <div style={{
                        height: '100vh', 
                        display: 'flex', 
                        justifyContent: 'center', 
                        alignItems: 'center', 
                        background: '#f5f6fa',
                        flexDirection: 'column'
                    }}>
                        <Card style={{ width: 400, boxShadow: '0 4px 12px rgba(0,0,0,0.1)', textAlign: 'center' }}>
                            <img src="/static/me.ico" style={{ width: 64, height: 64, marginBottom: 20 }} alt="Logo" />
                            <Title level={3} style={{ marginBottom: 10 }}>AI4Research Cloud</Title>
                            <Text type="secondary" style={{ display: 'block', marginBottom: 30 }}>
                                Please log in to access the platform.
                            </Text>
                            <Button type="primary" size="large" block onClick={() => setLoginModalVisible(true)}>
                                Login / Register
                            </Button>
                        </Card>
                        <LoginModal 
                            visible={loginModalVisible} 
                            onClose={() => setLoginModalVisible(false)}
                            t={t}
                        />
                    </div>
                );
            }

            return (
                <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                    {/* Header */}
                    <div className="app-header">
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                            <img src="/static/me.ico" style={{ width: 32, height: 32, borderRadius: 4 }} alt="Logo" />
                            <div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                                    <div style={{ fontWeight: 'bold', fontSize: 18, lineHeight: 1 }}>AI4Research</div>
                                    <Tooltip title={versionInfo.has_update ? "New version available! Click to update." : "Click to check for updates"}>
                                        <Badge dot={versionInfo.has_update} offset={[-2, 2]}>
                                            <Tag 
                                                color="default" 
                                                style={{ margin: 0, fontSize: '10px', height: '18px', lineHeight: '16px', cursor: 'pointer' }}
                                                onClick={() => checkUpdate(true)}
                                            >
                                                {versionInfo.current_version}
                                            </Tag>
                                        </Badge>
                                    </Tooltip>
                                    {versionInfo.has_update && versionInfo.status === 'idle' && (
                                        <Button 
                                            type="primary" 
                                            size="small" 
                                            style={{ background: '#52c41a', borderColor: '#52c41a', fontSize: '10px', height: '18px', padding: '0 4px' }}
                                            onClick={startDownload}
                                        >
                                            Update Available
                                        </Button>
                                    )}
                                    {versionInfo.status === 'downloading' && (
                                        <Tag color="processing" style={{ margin: 0, fontSize: '10px', height: '18px', lineHeight: '16px' }}>
                                            Downloading {versionInfo.progress}%
                                        </Tag>
                                    )}
                                    {versionInfo.status === 'ready_to_install' && (
                                        <Button 
                                            type="primary" 
                                            size="small" 
                                            style={{ background: '#faad14', borderColor: '#faad14', fontSize: '10px', height: '18px', padding: '0 4px' }}
                                            onClick={handleRestart}
                                        >
                                            Restart to Update
                                        </Button>
                                    )}
                                </div>
                                <div style={{ fontSize: 12, color: '#95a5a6' }}>Dr.Ash</div>
                            </div>
                        </div>
                        <Space>
                            <Button type="text" icon={<MailOutlined />} onClick={() => setContactVisible(true)}>{t.contact_us}</Button>
                            <Button type="text" icon={<SettingOutlined />} onClick={() => setSettingsVisible(true)}>{t.lbl_data_dir}</Button>
                            <Button type="text" icon={<RobotOutlined />}>AI Assistant</Button>
                            
                            {currentUser ? (
                                <>
                                    <div style={{ display: 'flex', gap: 5, fontSize: 12 }}>
                                        <Tag color="blue" title="Crawl Quota"><span role="img" aria-label="spider">🕷️</span> {currentQuota?.balance_crawl ?? '-'}</Tag>
                                        <Tag color="purple" title="Analysis Quota"><span role="img" aria-label="chart">📊</span> {currentQuota?.balance_analyze ?? '-'}</Tag>
                                        <Tag color="cyan" title="Plot Quota"><span role="img" aria-label="image">🖼️</span> {currentQuota?.balance_visualize ?? '-'}</Tag>
                                        <Tag color="magenta" title="Interpret Quota"><span role="img" aria-label="brain">🧠</span> {currentQuota?.balance_interpret ?? '-'}</Tag>
                                    </div>
                                    <span style={{fontWeight:'bold'}}>{currentUser.username}</span>
                                    <Button size="small" danger onClick={() => window.Auth.logout()}>Logout</Button>
                                </>
                            ) : (
                                <Button type="primary" style={{ background: '#3498db' }} onClick={() => setLoginModalVisible(true)}>Login</Button>
                            )}
                        </Space>
                    </div>

                    {/* Body (3 Columns) */}
                    <div className="app-body">
                        {/* 1. History Sidebar */}
                        <HistoryWidget 
                            onFileSelect={(file) => {
                                setPreprocessOriginFile(null);
                                setPreprocessReset(true);
                                setSelectedFile(file);
                            }} 
                            lang={lang} 
                            setLang={setLang} 
                        />

                        {/* 2. Control Panel (Tabs + Form) */}
                        <ControlPanel activeTab={activeTab} setActiveTab={setActiveTab} t={t}>
                            
                            {/* ACQUISITION */}
                            {activeTab === 'acquisition' && (
                                <div>
                                    <Title level={5}>{t.acq_title}</Title>
                                    <Form 
                                        layout="vertical" 
                                        form={crawlForm}
                                        onFinish={handleCrawlStart}
                                        onValuesChange={(changed) => {
                                            if (changed.platform) checkCookie(changed.platform);
                                        }}
                                    >
                                        <Form.Item name="platform" label={t.platform} initialValue="TikTok">
                                            <Select>
                                                <Option value="TikTok">TikTok（抖音）</Option>
                                                <Option value="rednote">RedNote (小红书)</Option>
                                                <Option value="bilibili">Bilibili (B站)</Option>
                                            </Select>
                                        </Form.Item>
                                        
                                        <div style={{marginBottom: 20, padding: 10, background: '#f9f9f9', borderRadius: 4, border: '1px solid #eee'}}>
                                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom: 8}}>
                                                <Text strong>{t.cookie_status}:</Text>
                                                {cookieStatus?.exists ? 
                                                    <Tag color="success">✅ {t.configured}</Tag> : 
                                                    <Tag color="error">❌ {t.missing}</Tag>
                                                }
                                            </div>
                                            <div style={{display:'flex', gap: 10, alignItems:'center'}}>
                                                <Input readOnly value={cookieStatus?.exists ? (cookieStatus.filename || "Configured") : "No cookie file"} size="small" />
                                                <Upload beforeUpload={handleCookieUpload} showUploadList={false} accept=".json">
                                                    <Button icon={<UploadOutlined />} size="small">JSON</Button>
                                                </Upload>
                                                <Upload beforeUpload={handleNetscapeCookieUpload} showUploadList={false} accept=".txt">
                                                    <Button icon={<UploadOutlined />} size="small">Netscape</Button>
                                                </Upload>
                                            </div>
                                            {cookieStatus?.netscape_exists && (
                                                <div style={{marginTop: 5, fontSize: 12, color: '#52c41a'}}>
                                                    ✅ Netscape cookie configured
                                                </div>
                                            )}
                                            <div style={{ marginTop: 8, fontSize: 12, color: '#666', display: 'flex', alignItems: 'flex-start', gap: 5 }}>
                                                <InfoCircleOutlined style={{ marginTop: 2 }} />
                                                <span>
                                                    How to get cookies: Install <a href="https://chrome.google.com/webstore/detail/editthiscookie/fngmhnnpilhplaeedifhccceomclgfbg" target="_blank" rel="noopener noreferrer">EditThisCookie</a> extension, login to target site, click extension icon → Export (JSON).
                                                </span>
                                            </div>
                                        </div>

                                        <Form.Item name="keywords" label={t.keywords} rules={[{required:true}]}>
                                            <Input placeholder="e.g. 冠心病" />
                                        </Form.Item>
                                        <Form.Item name="max_count" label={t.max_count} initialValue={50}>
                                            <InputNumber min={1} style={{width:'100%'}} />
                                        </Form.Item>
                                        <Button type="primary" htmlType="submit" loading={isCrawling} block style={{ background: '#3498db' }}>
                                            {t.start_crawl}
                                        </Button>
                                    </Form>
                                    <div style={{ marginTop: 20, background: '#f0f2f5', padding: 10, borderRadius: 4, height: 200, overflowY: 'auto', fontSize: 12, fontFamily: 'monospace' }}>
                                        {crawlLogs.length === 0 ? t.ready_crawl : crawlLogs.map((l, i) => <div key={i}>{l}</div>)}
                                    </div>
                                </div>
                            )}

                            {/* PREPROCESS */}
                            {activeTab === 'preprocess' && (
                                <div>
                                    <Title level={5}>{t.prep_title}</Title>
                                    <div style={{marginBottom: 10, fontSize: 12, color: '#888'}}>
                                        {t.target_file} {selectedFile ? selectedFile.name : t.none_selected}
                                    </div>
                                    <Form layout="vertical" onFinish={handlePreprocessRun}>
                                        <Form.Item name="operation" label={t.operation} initialValue="split">
                                            <Select>
                                                <Option value="split">{t.op_split}</Option>
                                                <Option value="explode">{t.op_explode}</Option>
                                                <Option value="count">{t.op_count}</Option>
                                                <Option value="log">{t.op_log}</Option>
                                                <Option value="merge_pca">{t.op_merge_pca}</Option>
                                                <Option value="merge_avg">{t.op_merge_avg}</Option>
                                                <Option value="aggregate">{t.op_aggregate}</Option>
                                                <Option value="impute">{t.op_impute}</Option>
                                            </Select>
                                        </Form.Item>
                                        
                                        <Form.Item shouldUpdate>
                                            {({ getFieldValue }) => {
                                                const op = getFieldValue('operation');
                                                const isMerge = op === 'merge_pca' || op === 'merge_avg' || op === 'aggregate';
                                                
                                                const availableCols = previewData && Array.isArray(previewData.columns) ? previewData.columns : [];
                                                if (isMerge) {
                                                    return (
                                                        <Form.Item name="target_cols" label={t.target_cols} rules={[{required:true}]}>
                                                            <Select
                                                                mode="multiple"
                                                                allowClear
                                                                showSearch
                                                                placeholder={t.target_cols}
                                                                disabled={availableCols.length === 0}
                                                            >
                                                                {availableCols.map((col) => (
                                                                    <Option key={col} value={col}>{String(col)}</Option>
                                                                ))}
                                                            </Select>
                                                        </Form.Item>
                                                    );
                                                }
                                                return (
                                                    <Form.Item name="target_col" label={t.target_col} rules={[{required:true}]}>
                                                        <Select
                                                            showSearch
                                                            allowClear
                                                            placeholder={t.target_col}
                                                            disabled={availableCols.length === 0}
                                                        >
                                                            {availableCols.map((col) => (
                                                                <Option key={col} value={col}>{String(col)}</Option>
                                                            ))}
                                                        </Select>
                                                    </Form.Item>
                                                );
                                            }}
                                        </Form.Item>
                                        
                                        <Form.Item shouldUpdate>
                                             {({ getFieldValue }) => {
                                                 const op = getFieldValue('operation');
                                                 
                                                 if (['split', 'explode', 'count'].includes(op)) {
                                                    return (
                                                        <Form.Item name={['params', 'separator']} label={t.separator} initialValue=",">
                                                            <Input />
                                                        </Form.Item>
                                                    );
                                                }

                                                if (op === 'aggregate') {
                                                    return (
                                                        <>
                                                            <Form.Item name={['params', 'separator']} label={t.separator} initialValue=",">
                                                                <Input />
                                                            </Form.Item>
                                                            <Form.Item name={['params', 'deduplicate']} valuePropName="checked" initialValue={false}>
                                                                <Checkbox>{t.deduplicate}</Checkbox>
                                                            </Form.Item>
                                                            <Form.Item name={['params', 'new_col_name']} label={t.new_col_name} initialValue="Aggregated">
                                                                <Input />
                                                            </Form.Item>
                                                        </>
                                                    );
                                                }
                                                
                                                if (op === 'merge_pca') {
                                                     return (
                                                         <Form.Item name={['params', 'n_components']} label="N Components" initialValue={1}>
                                                             <InputNumber min={1} style={{width:'100%'}} />
                                                         </Form.Item>
                                                     );
                                                 }
                                                 
                                                 if (op === 'impute') {
                                                     // Default to 'mean' if undefined
                                                     const method = getFieldValue(['params', 'method']) || 'mean';
                                                     return (
                                                         <>
                                                             <Form.Item name={['params', 'method']} label={t.method} initialValue="mean">
                                                                 <Select>
                                                                     <Option value="mean">{t.meth_mean}</Option>
                                                                     <Option value="median">{t.meth_median}</Option>
                                                                     <Option value="constant">{t.meth_constant}</Option>
                                                                 </Select>
                                                             </Form.Item>
                                                             {method === 'constant' && (
                                                                 <Form.Item name={['params', 'fill_value']} label="Fill Value" initialValue={0}>
                                                                     <InputNumber style={{width:'100%'}} />
                                                                 </Form.Item>
                                                             )}
                                                         </>
                                                     );
                                                 }
                                                 return null;
                                             }}
                                         </Form.Item>


                                        <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
                                            <Button type="primary" htmlType="submit" disabled={!selectedFile} style={{ background: '#3498db', flex: 1 }}>
                                                {t.run_exec}
                                            </Button>
                                            <Button onClick={handlePreprocessSave} disabled={!selectedFile} style={{ flex: 1 }}>
                                                {t.run_save}
                                            </Button>
                                        </div>
                                    </Form>
                                </div>
                            )}

                            {/* ANALYSIS */}
                            {activeTab === 'analysis' && (
                                <div>
                                    <Title level={5}>{t.anal_title}</Title>
                                    <div style={{marginBottom: 10, fontSize: 12, color: '#888'}}>
                                        {t.target_file} {selectedFile ? selectedFile.name : t.none_selected}
                                    </div>
                                    <AnalysisPanel 
                                        selectedFile={selectedFile} 
                                        t={t} 
                                        previewData={previewData}
                                        currentQuota={currentQuota}
                                    />
                                </div>
                            )}
                            
                            {/* PLOT */}
                            {activeTab === 'plot' && (
                                <div>
                                    <Title level={5}>{t.plot_title}</Title>
                                    <div style={{marginBottom: 10, fontSize: 12, color: '#888'}}>
                                        {t.target_file} {selectedFile ? selectedFile.name : t.none_selected}
                                    </div>
                                    <Form layout="vertical" form={plotForm} onFinish={handlePlot}>
                                        <div style={{ display: 'flex', gap: 10 }}>
                                            <Form.Item name="plot_type" label={t.plot_type} initialValue="scatter" style={{ flex: 1 }}>
                                                <Select>
                                                    <Option value="scatter">{t.pt_scatter}</Option>
                                                    <Option value="bar">{t.pt_bar}</Option>
                                                    <Option value="box">{t.pt_box}</Option>
                                                    <Option value="violin">{t.pt_violin}</Option>
                                                    <Option value="histogram">{t.pt_hist}</Option>
                                                    <Option value="heatmap">{t.pt_heatmap}</Option>
                                                    <Option value="line">{t.pt_line}</Option>
                                                    <Option value="donut">{t.pt_donut}</Option>
                                                    <Option value="stacked_bar">{t.pt_stacked_bar}</Option>
                                                    <Option value="forest_plot_logistic">{t.pt_forest_logistic}</Option>
                                                    <Option value="forest_plot_multinomial">{t.pt_forest_multinomial}</Option>
                                                    <Option value="forest_plot_ordinal">{t.pt_forest_ordinal}</Option>
                                                    <Option value="sig_matrix">{t.pt_sig_matrix}</Option>
                                                </Select>
                                            </Form.Item>
                                            <Form.Item name="palette" label={t.palette} initialValue="Deep" style={{ flex: 1 }}>
                                                <Select>
                                                    <Option value="NPG (Nature)">NPG (Nature)</Option>
                                                    <Option value="AAAS (Science)">AAAS (Science)</Option>
                                                    <Option value="NEJM (New England)">NEJM (New England)</Option>
                                                    <Option value="Lancet">Lancet</Option>
                                                    <Option value="JAMA">JAMA</Option>
                                                    <Option value="JCO">JCO</Option>
                                                    <Option value="UCSC (Genome Browser)">UCSC (Genome Browser)</Option>
                                                    <Option value="LocusZoom">LocusZoom</Option>
                                                    <Option value="IGV">IGV</Option>
                                                    <Option value="D3 (Category10)">D3 (Category10)</Option>
                                                    <Option value="Okabe-Ito (Colorblind Safe)">Okabe-Ito (Colorblind Safe)</Option>
                                                    <Option value="Tableau 10">Tableau 10</Option>

                                                    <Option value="Deep">Deep</Option>
                                                    <Option value="Muted">Muted</Option>
                                                    <Option value="Pastel">Pastel</Option>
                                                    <Option value="Bright">Bright</Option>
                                                    <Option value="Dark">Dark</Option>
                                                    <Option value="Colorblind">Colorblind</Option>

                                                    <Option value="Viridis">Viridis</Option>
                                                    <Option value="Magma">Magma</Option>
                                                    <Option value="Inferno">Inferno</Option>
                                                    <Option value="Plasma">Plasma</Option>
                                                    <Option value="CoolWarm">CoolWarm</Option>
                                                    <Option value="RdBu (Red-Blue)">RdBu (Red-Blue)</Option>
                                                    <Option value="Spectral">Spectral</Option>
                                                    <Option value="Blues">Blues</Option>
                                                    <Option value="Reds">Reds</Option>
                                                    <Option value="Greens">Greens</Option>
                                                    <Option value="Greys">Greys</Option>
                                                    <Option value="Oranges">Oranges</Option>
                                                    <Option value="Purples">Purples</Option>
                                                    <Option value="YlOrBr">YlOrBr</Option>
                                                    <Option value="YlGnBu">YlGnBu</Option>
                                                </Select>
                                            </Form.Item>
                                        </div>

                                        <div style={{ display: 'flex', gap: 10 }}>
                                            <Form.Item name="font_family" label={t.font_family} initialValue="Times New Roman" style={{ flex: 1 }}>
                                                <Select>
                                                    <Option value="Times New Roman">{t.font_times}</Option>
                                                    <Option value="Arial">{t.font_arial}</Option>
                                                </Select>
                                            </Form.Item>
                                            <Form.Item label={t.font_size} style={{ flex: 1 }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                                    <Form.Item name="font_size" noStyle initialValue={14}>
                                                        <InputNumber min={8} max={40} style={{ width: 80 }} />
                                                    </Form.Item>
                                                    <Form.Item name="font_bold" valuePropName="checked" noStyle>
                                                        <Checkbox style={{ whiteSpace: 'nowrap' }}>{t.font_bold}</Checkbox>
                                                    </Form.Item>
                                                </div>
                                            </Form.Item>
                                        </div>

                                        <Form.Item name="tendency" label={t.central_tendency} initialValue="mean" tooltip={t.tendency_tooltip}>
                                            <Select>
                                                <Option value="mean">{t.tendency_mean}</Option>
                                                <Option value="median">{t.tendency_median}</Option>
                                            </Select>
                                        </Form.Item>

                                        <div style={{ display: 'flex', gap: 10 }}>
                                            <Form.Item name="width" label={t.width} initialValue={800} style={{ flex: 1 }}>
                                                 <InputNumber min={100} style={{ width: '100%' }} />
                                            </Form.Item>
                                            <Form.Item name="height" label={t.height} initialValue={600} style={{ flex: 1 }}>
                                                 <InputNumber min={100} style={{ width: '100%' }} />
                                            </Form.Item>
                                        </div>

                                        <Form.Item shouldUpdate>
                                            {() => {
                                                const type = plotForm.getFieldValue('plot_type') || 'scatter';
                                                const isHeatmap = type === 'heatmap';
                                                const isSigMatrix = type === 'sig_matrix';
                                                const isForest = type.includes('forest');
                                                const isDonut = type === 'donut';
                                                const isStackedBar = type === 'stacked_bar';
                                                
                                                const cols = previewData?.columns || [];
                                                const colOptions = cols.map(c => <Option key={c} value={c}>{String(c)}</Option>);

                                                if (isHeatmap || isForest) {
                                                    return (
                                                        <>
                                                             {isForest && (
                                                                 <Form.Item name="y_col" label="Dependent Variable (Y)" rules={[{required:true}]}>
                                                                     <Select showSearch optionFilterProp="children">
                                                                         {colOptions}
                                                                     </Select>
                                                                 </Form.Item>
                                                             )}
                                                            <Form.Item name="heatmap_cols" label={isForest ? "Independent Variables (X)" : t.heatmap_cols}>
                                                                <Select mode="multiple" showSearch optionFilterProp="children" placeholder="Select columns">
                                                                    {colOptions}
                                                                </Select>
                                                            </Form.Item>
                                                            
                                                            {isHeatmap && (
                                                                <Form.Item name="corr_method" label={t.sig_corr_method} initialValue="pearson">
                                                                    <Select>
                                                                        <Option value="pearson">Pearson</Option>
                                                                        <Option value="spearman">Spearman</Option>
                                                                        <Option value="kendall">Kendall</Option>
                                                                    </Select>
                                                                </Form.Item>
                                                            )}

                                                            {isForest && (
                                                                 <Form.Item name="sort_forest" valuePropName="checked" initialValue={true}>
                                                                     <Checkbox>{t.sort_effect}</Checkbox>
                                                                 </Form.Item>
                                                            )}
                                                        </>
                                                    );
                                                }

                                                if (isSigMatrix) {
                                                    return (
                                                        <div style={{ display: 'flex', gap: 10 }}>
                                                            <Form.Item name="sig_group" label={t.sig_group} style={{ flex: 1 }} rules={[{required:true}]}>
                                                                 <Select showSearch optionFilterProp="children">{colOptions}</Select>
                                                            </Form.Item>
                                                            <Form.Item name="sig_val" label={t.sig_val} style={{ flex: 1 }} rules={[{required:true}]}>
                                                                 <Select showSearch optionFilterProp="children">{colOptions}</Select>
                                                            </Form.Item>
                                                            <Form.Item name="sig_method" label={t.sig_method} initialValue="tukey" style={{ flex: 1 }}>
                                                                 <Select>
                                                                     <Option value="tukey">Tukey HSD</Option>
                                                                     <Option value="dunn">Dunn's Test</Option>
                                                                 </Select>
                                                            </Form.Item>
                                                        </div>
                                                    );
                                                }

                                                return (
                                                    <>
                                                        <Form.Item name="x_col" label={isDonut || isStackedBar ? t.lbl_group_var : t.x_axis} rules={[{required:true}]}>
                                                            <Select showSearch optionFilterProp="children">
                                                                {colOptions}
                                                            </Select>
                                                        </Form.Item>
                                                        
                                                        {!isDonut && (
                                                            <Form.Item name="y_col" label={isStackedBar ? t.lbl_analysis_var : t.y_axis}>
                                                                <Select showSearch optionFilterProp="children" allowClear>
                                                                    {colOptions}
                                                                </Select>
                                                            </Form.Item>
                                                        )}
                                                        {isDonut && (
                                                            <Form.Item name="y_col" label={t.y_axis + " (Optional Value)"}>
                                                                <Select showSearch optionFilterProp="children" allowClear>
                                                                    {colOptions}
                                                                </Select>
                                                            </Form.Item>
                                                        )}

                                                        <Form.Item name="hue_col" label={t.hue_group}>
                                                            <Select showSearch optionFilterProp="children" allowClear>
                                                                {colOptions}
                                                            </Select>
                                                        </Form.Item>

                                                        {type === 'scatter' && (
                                                            <Form.Item name="trendline" valuePropName="checked">
                                                                <Checkbox>{t.trendline}</Checkbox>
                                                            </Form.Item>
                                                        )}
                                                        
                                                        {['box', 'violin', 'bar'].includes(type) && (
                                                             <div style={{ border: '1px solid #eee', padding: 10, borderRadius: 4, marginBottom: 10 }}>
                                                                 <Form.Item name="add_significance" valuePropName="checked" noStyle>
                                                                     <Checkbox>{t.add_sig}</Checkbox>
                                                                 </Form.Item>
                                                                 <div style={{ display: 'flex', gap: 10, marginTop: 10 }}>
                                                                     <Form.Item name="sig_test_method" label={t.sig_method} initialValue="t-test_ind" style={{ flex: 1, marginBottom: 0 }}>
                                                                        <Select size="small">
                                                                            <Option value="t-test_ind">T-test</Option>
                                                                            <Option value="Mann-Whitney">Mann-Whitney</Option>
                                                                            <Option value="Dunn">Dunn's Test</Option>
                                                                        </Select>
                                                                    </Form.Item>
                                                                     <Form.Item name="sig_correction" label={t.sig_correction} initialValue="bonferroni" style={{ flex: 1, marginBottom: 0 }}>
                                                                         <Select size="small">
                                                                             <Option value="bonferroni">Bonferroni</Option>
                                                                             <Option value="fdr_bh">FDR (BH)</Option>
                                                                             <Option value="holm">Holm</Option>
                                                                             <Option value="None">None</Option>
                                                                         </Select>
                                                                     </Form.Item>
                                                                 </div>
                                                             </div>
                                                        )}
                                                    </>
                                                );
                                            }}
                                        </Form.Item>

                                        <div style={{ display: 'flex', gap: 10 }}>
                                            <Button type="primary" htmlType="submit" block disabled={!selectedFile} style={{ background: '#3498db', flex: 1 }}>{t.gen_plot}</Button>
                                            <Button block disabled={!selectedFile || !plotImage} onClick={handleExportTiff} style={{ flex: 1 }}>{t.export_tiff}</Button>
                                        </div>

                                        {/* AI Interpretation Section */}
                                        <div style={{ marginTop: 20, borderTop: '1px solid #eee', paddingTop: 15 }}>
                                            <div style={{ fontWeight: 'bold', marginBottom: 10, display: 'flex', alignItems: 'center', gap: 5 }}>
                                                <RobotOutlined style={{ color: '#8e44ad' }} /> AI 智能解读 (AI Interpretation)
                                            </div>
                                            
                                            <Form.Item label="研究目标 (Research Goal)">
                                                <Input.TextArea 
                                                    value={researchGoal}
                                                    onChange={e => setResearchGoal(e.target.value)}
                                                    placeholder="e.g. Compare the efficacy of Drug A vs Drug B..."
                                                    rows={2}
                                                    size="small"
                                                />
                                            </Form.Item>
                                            
                                            <Form.Item label="变量定义 (Variable Definitions)">
                                                <Input.TextArea 
                                                    value={varDefs}
                                                    onChange={e => setVarDefs(e.target.value)}
                                                    placeholder="e.g. BMI: Body Mass Index..."
                                                    rows={2}
                                                    size="small"
                                                />
                                            </Form.Item>
                                            
                                            <Button 
                                                block 
                                                type="dashed" 
                                                icon={<RobotOutlined />} 
                                                onClick={handleInterpretation}
                                                loading={interpreting}
                                                disabled={!selectedFile || !plotImage}
                                                style={{ borderColor: '#8e44ad', color: '#8e44ad' }}
                                            >
                                                开始 AI 解读 (Start Interpretation)
                                            </Button>
                                        </div>
                                    </Form>
                                </div>
                            )}

                            {/* LABELING */}
                            {activeTab === 'label' && (
                                <LabelingConfigView 
                                    selectedFile={selectedFile} 
                                    t={t}
                                    lang={lang}
                                    onFileCreated={(newFilename) => {
                                        message.success("Task created! Please select the new file in history.");
                                    }}
                                    config={labelConfig}
                                    taskConfig={taskConfig}
                                    onConfigUpdated={() => {
                                        // Refresh task config
                                        if (selectedFile) {
                                            fetch(`/api/label/task/config?filename=${encodeURIComponent(selectedFile.name)}`)
                                                .then(r => r.json())
                                                .then(setTaskConfig);
                                        }
                                    }}
                                />
                            )}
                        </ControlPanel>

                        {/* 3. Workspace (Results) */}
                        <div className="col-workspace">
                            <div className="section-card">
                                <div className="card-header">
                                    {t.ws_title}
                                </div>
                                <div className="card-body">
                                    {activeTab === 'plot' && (
                                        <div style={{height: '100%', display: 'flex', flexDirection: 'column'}}>
                                            <div style={{flex: 1, overflow: 'auto', display: 'flex', alignItems: 'center', justifyContent: 'center', minHeight: 300}}>
                                                {plotImage ? (
                                                    <img src={plotImage} alt="Plot" style={{ maxWidth: '100%', maxHeight: '100%', objectFit: 'contain', border: '1px solid #eee' }} />
                                                ) : (
                                                    <Empty description={t.ws_plot_desc} />
                                                )}
                                            </div>
                                            
                                            {/* Interpretation Result */}
                                            {(interpreting || interpretResult) && (
                                                <div style={{
                                                    height: '40%', 
                                                    borderTop: '1px solid #ddd', 
                                                    padding: 15, 
                                                    background: '#fafafa', 
                                                    overflowY: 'auto',
                                                    flexShrink: 0
                                                }}>
                                                    <div style={{ fontWeight: 'bold', marginBottom: 10, color: '#8e44ad' }}>
                                                        <RobotOutlined /> AI Interpretation Result:
                                                    </div>
                                                    {interpreting && !interpretResult && <Spin tip="Interpreting..." />}
                                                    <div 
                                                        style={{ lineHeight: 1.6, fontFamily: 'Georgia, serif', overflowWrap: 'break-word', padding: '10px' }}
                                                        dangerouslySetInnerHTML={{ __html: window.marked ? window.marked.parse(interpretResult) : interpretResult }}
                                                    />
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    
                                    {activeTab === 'acquisition' && (
                                        (() => {
                                            if (!selectedFile) return <Empty description={t.ws_acq_desc} />;
                                            
                                            if (!previewData) {
                                                return <div style={{ padding: 50, textAlign: 'center' }}><Spin size="large" tip="Loading preview..." /></div>;
                                            }

                                            if (previewData.error) {
                                                return <div style={{ color: 'red', padding: 20, textAlign: 'center' }}>Error loading preview: {previewData.error}</div>;
                                            }
                                            
                                            if (previewData.columns && Array.isArray(previewData.columns)) {
                                                const simpleColumns = (previewData.columns || []).map((colName, index) => ({
                                                    title: String(colName),
                                                    dataIndex: colName,
                                                    key: index,
                                                    width: String(colName).toLowerCase() === 'title' ? 300 : 150,
                                                    ellipsis: true,
                                                    render: (_, record) => {
                                                        try {
                                                            const val = record[colName];
                                                            const text = val === null || val === undefined ? '' : String(val);
                                                            return (
                                                                <div 
                                                                    title={text}
                                                                    style={{
                                                                        maxWidth: 300,
                                                                        whiteSpace: 'nowrap',
                                                                        overflow: 'hidden',
                                                                        textOverflow: 'ellipsis'
                                                                    }}
                                                                >
                                                                    {text}
                                                                </div>
                                                            );
                                                        } catch (e) {
                                                            return <span style={{ color: 'red' }}>Error</span>;
                                                        }
                                                    }
                                                }));

                                                return (
                                                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                                                        <div style={{ marginBottom: 10, fontWeight: 'bold', flexShrink: 0 }}>
                                                            Preview: {selectedFile.name} ({previewData.total_rows} rows)
                                                        </div>
                                                        <div style={{ flex: 1, overflow: 'hidden' }}>
                                                            <Table 
                                                                dataSource={Array.isArray(previewData.data) ? previewData.data : []} 
                                                                columns={simpleColumns}
                                                                scroll={{ x: 'max-content', y: 'calc(100vh - 280px)' }}
                                                                pagination={false}
                                                                size="small"
                                                                bordered
                                                                rowKey={(r, i) => i}
                                                            />
                                                        </div>
                                                    </div>
                                                );
                                            }
                                            return <Empty description="No data available" />;
                                        })()
                                    )}

                                    {activeTab === 'analysis' && (
                                        <div style={{height: '100%', overflowY: 'auto', padding: 20}}>
                                            <div id="analysis-results">
                                                <Empty description={t.ws_anal_desc} />
                                            </div>
                                        </div>
                                    )}
                                    
                                    {activeTab === 'preprocess' && (
                                        (() => {
                                            if (!selectedFile) return <Empty description={t.ws_prep_desc} />;
                                            
                                            if (!previewData) {
                                                return <div style={{ padding: 50, textAlign: 'center' }}><Spin size="large" tip="Loading preview..." /></div>;
                                            }

                                            if (previewData.error) {
                                                return <div style={{ color: 'red', padding: 20, textAlign: 'center' }}>Error loading preview: {previewData.error}</div>;
                                            }
                                            

                                            if (previewData.columns && Array.isArray(previewData.columns)) {
                                                
                                                const handleColumnDelete = (dataIndex) => {
                                                    setColumns(prev => prev.filter(c => c.dataIndex !== dataIndex));
                                                    setPreviewData(prev => {
                                                        if (!prev || !Array.isArray(prev.data)) return prev;
                                                        const newCols = prev.columns ? prev.columns.filter(col => col !== dataIndex) : prev.columns;
                                                        // We don't necessarily need to remove data from rows for display, but it's cleaner
                                                        const newData = prev.data.map(row => {
                                                            if (!(dataIndex in row)) return row;
                                                            const next = { ...row };
                                                            delete next[dataIndex];
                                                            return next;
                                                        });
                                                        return { ...prev, columns: newCols, data: newData };
                                                    });
                                                    setDeletedCols(prev => prev.includes(dataIndex) ? prev : [...prev, dataIndex]);
                                                };

                                                const handleColumnReorder = (fromKey, toKey) => {
                                                    if (!fromKey || fromKey === toKey) return;
                                                    setColumns(prev => {
                                                        const list = [...prev];
                                                        const fromIndex = list.findIndex(c => c.dataIndex === fromKey);
                                                        const toIndex = list.findIndex(c => c.dataIndex === toKey);
                                                        if (fromIndex === -1 || toIndex === -1) return prev;
                                                        const [moved] = list.splice(fromIndex, 1);
                                                        list.splice(toIndex, 0, moved);
                                                        return list;
                                                    });
                                                    // Also update previewData.columns order if needed, but UI is driven by `columns` state
                                                };


                                                const handleColumnRename = (dataIndex, newName) => {
                                                    if (!newName || newName === dataIndex) {
                                                        setEditingColKey(null);
                                                        return;
                                                    }
                                                    setColumns(prev => prev.map(c => c.dataIndex === dataIndex ? { ...c, title: newName, dataIndex: newName } : c));
                                                    setPreviewData(prev => {
                                                        if (!prev || !Array.isArray(prev.data)) return prev;
                                                        const newCols = prev.columns ? prev.columns.map(col => col === dataIndex ? newName : col) : prev.columns;
                                                        const newData = prev.data.map(row => {
                                                            if (!(dataIndex in row)) return row;
                                                            const value = row[dataIndex];
                                                            const next = { ...row };
                                                            delete next[dataIndex];
                                                            next[newName] = value;
                                                            return next;
                                                        });
                                                        return { ...prev, columns: newCols, data: newData };
                                                    });
                                                    setColRenames(prev => [...prev, { from: dataIndex, to: newName }]);
                                                    setEditingColKey(null);
                                                };

                                                const resizableColumns = columns.map((col, index) => {
                                                    const dataIndex = col.dataIndex;
                                                    let titleNode = col.title;
                                                    if (dataIndex) {
                                                        if (editingColKey === dataIndex) {
                                                            titleNode = (
                                                                <Input 
                                                                    size="small"
                                                                    autoFocus
                                                                    defaultValue={String(col.title)}
                                                                    onBlur={(e) => handleColumnRename(dataIndex, e.target.value)}
                                                                    onPressEnter={(e) => handleColumnRename(dataIndex, e.target.value)}
                                                                    onKeyDown={(e) => {
                                                                        if (e.key === 'Escape') setEditingColKey(null);
                                                                        e.stopPropagation();
                                                                    }}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                />
                                                            );
                                                        } else {
                                                            titleNode = (
                                                                <div
                                                                    draggable
                                                                    style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}
                                                                    onDragStart={() => {
                                                                        setDragColKey(dataIndex);
                                                                    }}
                                                                    onDragOver={(e) => e.preventDefault()}
                                                                    onDrop={(e) => {
                                                                        e.preventDefault();
                                                                        if (dragColKey && dragColKey !== dataIndex) {
                                                                            handleColumnReorder(dragColKey, dataIndex);
                                                                        }
                                                                    }}
                                                                >
                                                                    <div 
                                                                        style={{ flex: 1, overflow: 'hidden', marginRight: 4, cursor: 'text' }}
                                                                        onDoubleClick={(e) => {
                                                                            e.stopPropagation();
                                                                            setEditingColKey(dataIndex);
                                                                        }}
                                                                    >
                                                                        {col.title}
                                                                    </div>
                                                                    <Button
                                                                        size="small"
                                                                        type="text"
                                                                        danger
                                                                        icon={<DeleteOutlined />}
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            Modal.confirm({
                                                                                title: 'Confirm Delete',
                                                                                content: `Are you sure you want to delete column "${dataIndex}"?`,
                                                                                onOk: () => handleColumnDelete(dataIndex)
                                                                            });
                                                                        }}
                                                                    />
                                                                </div>
                                                            );
                                                        }
                                                    }

                                                    return {
                                                        ...col,
                                                        title: titleNode,
                                                        onHeaderCell: (column) => ({
                                                            width: column.width,
                                                            onResize: handleResize(index),
                                                        }),
                                                        render: (_, record, rowIndex) => {
                                                            const val = record[dataIndex];
                                                            const text = val === null || val === undefined ? '' : String(val);
                                                            const isEditing = editingCell && editingCell.rowIndex === rowIndex && editingCell.column === dataIndex;
                                                            
                                                            if (isEditing) {
                                                                const handleCommit = (value) => {
                                                                    const updated = value;
                                                                    setPreviewData(prev => {
                                                                        if (!prev || !Array.isArray(prev.data)) return prev;
                                                                        const newData = prev.data.map((row, idx) => {
                                                                            if (idx !== rowIndex) return row;
                                                                            const next = { ...row };
                                                                            next[dataIndex] = updated;
                                                                            return next;
                                                                        });
                                                                        return { ...prev, data: newData };
                                                                    });
                                                                    setCellEdits(prev => [...prev, { row_index: rowIndex, column: dataIndex, value: updated }]);
                                                                    setEditingCell(null);
                                                                };
                                                                return (
                                                                    <Input
                                                                        size="small"
                                                                        autoFocus
                                                                        defaultValue={text}
                                                                        onBlur={(e) => handleCommit(e.target.value)}
                                                                        onPressEnter={(e) => handleCommit(e.target.value)}
                                                                        onKeyDown={(e) => {
                                                                            if (e.key === 'Escape') setEditingCell(null);
                                                                        }}
                                                                    />
                                                                );
                                                            }
                                                            return (
                                                                <div
                                                                    title={text}
                                                                    onDoubleClick={() => setEditingCell({ rowIndex, column: dataIndex })}
                                                                    style={{
                                                                        maxWidth: 300,
                                                                        whiteSpace: 'nowrap',
                                                                        overflow: 'hidden',
                                                                        textOverflow: 'ellipsis',
                                                                        cursor: 'text'
                                                                    }}
                                                                >
                                                                    {text}
                                                                </div>
                                                            );
                                                        }
                                                    };
                                                });

                                                return (
                                                    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
                                                        <div style={{ marginBottom: 4, fontSize: 12, color: '#888' }}>
                                                            {t.ws_prep_desc}
                                                        </div>
                                                        <div style={{ marginBottom: 10, fontWeight: 'bold', flexShrink: 0 }}>
                                                            Preview: {selectedFile.name} ({previewData.total_rows} rows)
                                                        </div>
                                                        <div style={{ flex: 1, overflow: 'hidden' }}>
                                                            <Table 
                                                                dataSource={Array.isArray(previewData.data) ? previewData.data : []} 
                                                                columns={resizableColumns}
                                                                components={{
                                                                    header: {
                                                                        cell: ResizableTitle,
                                                                    },
                                                                }}
                                                                scroll={{ x: 'max-content', y: 'calc(100vh - 280px)' }}
                                                                pagination={false}
                                                                size="small"
                                                                bordered
                                                                rowKey={(r, i) => i}
                                                            />
                                                        </div>
                                                    </div>
                                                );
                                            }
                                            return <Empty description="No data available" />;
                                        })()
                                    )}

                                    {activeTab === 'label' && (
                                        <div style={{ height: '100%', display: 'flex', flexDirection: 'row' }}>
                                            <div style={{ flex: 2, display: 'flex', flexDirection: 'column', overflow: 'hidden', borderRight: activeLabelRow ? '1px solid #eee' : 'none', paddingRight: activeLabelRow ? 10 : 0 }}>
                                                {previewData && previewData.data ? (
                                                    <>
                                                    <Table 
                                                        dataSource={previewData.data} 
                                                        columns={[
                                                        { 
                                                            title: 'Platform', 
                                                            key: 'platform', 
                                                            width: 100,
                                                            render: (_, r) => r.platform || r.Platform 
                                                        },
                                                        { 
                                                            title: 'Title', 
                                                            key: 'title', 
                                                            width: 300, 
                                                            ellipsis: true,
                                                            render: (_, r) => r.title || r.Title 
                                                        },
                                                        { 
                                                            title: 'Author', 
                                                            key: 'author', 
                                                            width: 150,
                                                            render: (_, r) => r.author_name || r.author || r.Author
                                                        },
                                                        { 
                                                            title: 'Action', 
                                                            key: 'action',
                                                            width: 200,
                                                            render: (_, record) => (
                                                                 <Space>
                                                                     <Button 
                                                                        type="link" 
                                                                        icon={<PlayCircleOutlined />} 
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            handleViewVideo(record);
                                                                        }}
                                                                     >
                                                                        View
                                                                     </Button>
                                                                     {!(selectedFile && selectedFile.name.split('/').pop().split('\\').pop().startsWith("标注员_")) && (
                                                                         <>
                                                                            {record._downloaded ? (
                                                                                <Tag color="success" style={{cursor: 'default'}} onClick={e => e.stopPropagation()}>
                                                                                    <CheckCircleOutlined /> Done
                                                                                </Tag>
                                                                            ) : (
                                                                                <Button 
                                                                                    type="link" 
                                                                                    icon={<DownloadOutlined />} 
                                                                                    onClick={(e) => {
                                                                                        e.stopPropagation();
                                                                                        const vid = record.video_id || record.id || record.Video_Id || "video";
                                                                                        handleDownloadVideo(record, `${vid}.mp4`);
                                                                                    }}
                                                                                >
                                                                                    Download
                                                                                </Button>
                                                                            )}
                                                                         </>
                                                                     )}
                                                                 </Space>
                                                            )
                                                        }
                                                    ]}
                                                        rowClassName={(record, index) => activeLabelRow && index === activeLabelRow.index ? 'ant-table-row-selected' : ''}
                                                        onRow={(record, index) => ({
                                                            onClick: () => setActiveLabelRow({ index, data: record }),
                                                            style: { cursor: 'pointer' }
                                                        })}
                                                        scroll={{ y: 'calc(100vh - 200px)' }}
                                                        pagination={false}
                                                        size="small"
                                                        rowKey={(r, i) => i}
                                                    />
                                                    <Modal
                                                        title={t.vid_player}
                                                        open={!!viewVideoUrl}
                                                        onCancel={() => setViewVideoUrl(null)}
                                                        footer={null}
                                                        width={800}
                                                        destroyOnClose
                                                        centered
                                                    >
                                                        <div style={{background:'#000', borderRadius:4, overflow:'hidden', display:'flex', justifyContent:'center'}}>
                                                            <video 
                                                                src={`/api/data/video/download_url?url=${encodeURIComponent(viewVideoUrl || '')}`} 
                                                                controls 
                                                                autoPlay 
                                                                style={{maxWidth:'100%', maxHeight: '60vh'}} 
                                                            />
                                                        </div>
                                                        <div style={{marginTop: 10, textAlign: 'right'}}>
                                                            <Button type="link" icon={<LinkOutlined />} onClick={() => window.open(viewVideoUrl, '_blank')}>
                                                                {t.open_link}
                                                            </Button>
                                                        </div>
                                                    </Modal>
                                                    </>
                                                ) : <Empty description={t.ws_lbl_desc} />}
                                            </div>

                                            {selectedFile && activeLabelRow && (
                                                <div style={{ flex: 1, minWidth: 350, paddingLeft: 10, overflowY: 'auto' }}>
                                                     {selectedFile.name.split('/').pop().split('\\').pop().startsWith("标注员_") ? (
                                                         <LabelingFormView 
                                                             activeRow={activeLabelRow}
                                                             onSave={handleLabelSave}
                                                             config={taskConfig.length > 0 ? taskConfig : labelConfig}
                                                             t={t}
                                                             lang={lang}
                                                         />
                                                     ) : (
                                                         <RowPreviewView 
                                                            activeRow={activeLabelRow}
                                                            t={t}
                                                            lang={lang}
                                                         />
                                                     )}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                    <LoginModal 
                        visible={loginModalVisible}
                        onClose={() => setLoginModalVisible(false)}
                        t={t}
                    />
                    {/* Contact Modal */}
                    <Modal
                        title={t.contact_info}
                        open={contactVisible}
                        onCancel={() => setContactVisible(false)}
                        footer={null}
                    >
                        <div style={{ padding: 20 }}>
                            <div style={{ marginBottom: 20, display: 'flex', alignItems: 'center', gap: 10 }}>
                                <img src="/static/me.ico" style={{ width: 48, height: 48, borderRadius: '50%' }} alt="Logo" />
                                <div>
                                    <div style={{ fontWeight: 'bold', fontSize: 16 }}>Dr.Ash</div>
                                    <div style={{ color: '#888' }}>AI4Research Cloud</div>
                                </div>
                            </div>
                            
                            <div style={{ display: 'flex', flexDirection: 'column', gap: 15 }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                    <div style={{ width: 32, height: 32, background: '#ff2442', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: 'bold' }}>小</div>
                                    <div>
                                        <div style={{ fontSize: 12, color: '#888' }}>RedNote (小红书)</div>
                                        <a href="https://xhslink.com/m/5hRmXDtaTwE" target="_blank" style={{ fontSize: 16 }}>Dr.Ash 的主页</a>
                                    </div>
                                </div>
                                
                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                    <div style={{ width: 32, height: 32, background: '#16a085', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>
                                        <MailOutlined />
                                    </div>
                                    <div>
                                        <div style={{ fontSize: 12, color: '#888' }}>Email</div>
                                        <a href="mailto:dr_ash2077@163.com" style={{ fontSize: 16 }}>dr_ash2077@163.com</a>
                                    </div>
                                </div>

                                <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
                                    <div style={{ width: 32, height: 32, background: '#07c160', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white' }}>
                                        <div style={{ fontSize: 18, fontWeight: 'bold' }}>W</div>
                                    </div>
                                    <div>
                                        <div style={{ fontSize: 12, color: '#888' }}>Wechat</div>
                                        <div style={{ fontSize: 16 }}>dreamer_wanghaha</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Modal>

                    <SettingsModal 
                        visible={settingsVisible} 
                        onClose={() => setSettingsVisible(false)} 
                        config={sysConfig} 
                        onSave={handleSaveSettings}
                        t={t}
                    />
                </div>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
